<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LASS: Sound.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Sound.cpp</h1><a href="Sound_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">LASS (additive sound synthesis library)</span>
00003 <span class="comment">Copyright (C) 2005  Sever Tipei (s-tipei@uiuc.edu)</span>
00004 <span class="comment"></span>
00005 <span class="comment">This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">modify it under the terms of the GNU General Public License</span>
00007 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00008 <span class="comment">of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment">GNU General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">along with this program; if not, write to the Free Software</span>
00017 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="comment">//----------------------------------------------------------------------------//</span>
00021 <span class="comment">//</span>
00022 <span class="comment">//      Sound.cpp</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//----------------------------------------------------------------------------//</span>
00025 
00026 <span class="preprocessor">#ifndef __SOUND_CPP</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define __SOUND_CPP</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//----------------------------------------------------------------------------//</span>
00030 <span class="preprocessor">#include "<a class="code" href="Sound_8h.html">Sound.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="Score_8h.html">Score.h</a>"</span>
00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
00033 <span class="preprocessor">#include "<a class="code" href="Loudness_8h.html">Loudness.h</a>"</span>
00034 
00035 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00036"></a><a class="code" href="classSound.html#a0">00036</a> <a class="code" href="classSound.html#a0">Sound::Sound</a>()
00037 {
00038     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>, 1.0);
00039     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>, 0.0);
00040     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a2">LOUDNESS</a>, 100.0);
00041     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a3">LOUDNESS_RATE</a>, 10.0);
00042 
00043     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>, 0.0);
00044     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a5">DETUNE_DIRECTION</a>, 0.0);
00045     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a6">DETUNE_VELOCITY</a>, -0.5);
00046     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a7">DETUNE_FUNDAMENTAL</a>, -1.0);
00047 
00048     <a class="code" href="classSound.html#r1">reverbObj</a> = NULL;
00049 
00050     <a class="code" href="classSound.html#r0">spatializer_</a> = <span class="keyword">new</span> <a class="code" href="classSpatializer.html">Spatializer</a>();
00051 }
00052   
00053 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00054"></a><a class="code" href="classSound.html#a1">00054</a> <a class="code" href="classSound.html#a0">Sound::Sound</a>(<span class="keywordtype">int</span> numPartials, <a class="code" href="Types_8h.html#a3">m_value_type</a> baseFreq)
00055 {
00056     <a class="code" href="classSound.html#r0">spatializer_</a> = <span class="keyword">new</span> <a class="code" href="classSpatializer.html">Spatializer</a>();
00057 
00058     <span class="keywordflow">if</span> (numPartials &lt; 1)
00059     {
00060         cerr &lt;&lt; <span class="stringliteral">"ERROR: Sound: Creation with less than 1 partial."</span> &lt;&lt; endl;
00061         <span class="keywordflow">return</span>;
00062     }
00063     
00064     <span class="comment">// generate each subsequent partial</span>
00065     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numPartials; i++)
00066     {
00067         <a class="code" href="classPartial.html">Partial</a> p;
00068         p.<a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Partial_8h.html#a19a0">RELATIVE_AMPLITUDE</a>, (1/pow(2.71828,i)));
00069 
00070         <span class="comment">// INCREMENT FREQUENCY MULTIPLIER FOR GLISSANDO</span>
00071         p.<a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Partial_8h.html#a20a3">FREQUENCY</a>, baseFreq * (i+1));
00072         p.<a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Partial_8h.html#a19a1">PARTIAL_NUM</a>, i);
00073         <a class="code" href="classCollection.html#a4">add</a>(p);
00074     }
00075 
00076     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>, 1.0);
00077     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>, 0.0);
00078     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a2">LOUDNESS</a>, 100.0);
00079     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a3">LOUDNESS_RATE</a>, 10.0);
00080 
00081     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>, 0.0);
00082     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a5">DETUNE_DIRECTION</a>, 0.0);
00083     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a6">DETUNE_VELOCITY</a>, -0.5);
00084     <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a7">DETUNE_FUNDAMENTAL</a>, -1.0);
00085 
00086     <a class="code" href="classSound.html#r1">reverbObj</a> = NULL;
00087 
00088 }
00089 
00090 
00091 
00092 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00093"></a><a class="code" href="classSound.html#a2">00093</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a2">Sound::setPartialParam</a>(PartialStaticParam p, <a class="code" href="Types_8h.html#a3">m_value_type</a> v)
00094 {
00095     <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00096     <span class="keywordflow">while</span>(it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00097         it.<a class="code" href="classIterator.html#a5">next</a>().setParam(p,v);
00098 }
00099 
00100 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00101"></a><a class="code" href="classSound.html#a3">00101</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a2">Sound::setPartialParam</a>(PartialDynamicParam p, <a class="code" href="classDynamicVariable.html">DynamicVariable</a>&amp; v)
00102 {
00103     <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00104     <span class="keywordflow">while</span>(it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00105         it.<a class="code" href="classIterator.html#a5">next</a>().setParam(p,v);
00106 }
00107 
00108 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00109"></a><a class="code" href="classSound.html#a4">00109</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a2">Sound::setPartialParam</a>(PartialDynamicParam p, <a class="code" href="Types_8h.html#a3">m_value_type</a> v)
00110 {
00111     <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00112     <span class="keywordtype">int</span> i = 1;
00113 
00114     <span class="keywordflow">while</span>(it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00115     {
00116         <a class="code" href="Types_8h.html#a3">m_value_type</a> mod_val = v;
00117 
00118         <span class="comment">// FOR GLISSANDO</span>
00119         <span class="keywordflow">if</span>( p == <a class="code" href="Partial_8h.html#a20a3">FREQUENCY</a> )
00120             mod_val *= i;
00121 
00122         it.<a class="code" href="classIterator.html#a5">next</a>().setParam(p,mod_val);
00123         i++;  
00124     }
00125 }
00126 
00127 
00128 <span class="comment">//----------------------------------------------------------------------------//</span>
00129 <span class="comment">/*</span>
00130 <span class="comment">void Sound::getPartialParamEnv(PartialDynamicParam p)</span>
00131 <span class="comment">{</span>
00132 <span class="comment">    Iterator&lt;Partial&gt; it = iterator();</span>
00133 <span class="comment">    int i = 1;</span>
00134 <span class="comment"></span>
00135 <span class="comment">    while(it.hasNext())</span>
00136 <span class="comment">    {</span>
00137 <span class="comment">        m_value_type mod_val = v;</span>
00138 <span class="comment"></span>
00139 <span class="comment">        // FOR GLISSANDO</span>
00140 <span class="comment">        if( p == FREQUENCY )</span>
00141 <span class="comment">            mod_val *= i;</span>
00142 <span class="comment"></span>
00143 <span class="comment">        it.next().getParamEnv(p);</span>
00144 <span class="comment">        i++;  </span>
00145 <span class="comment">    }</span>
00146 <span class="comment">}</span>
00147 <span class="comment">*/</span>
00148 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00149"></a><a class="code" href="classSound.html#a6">00149</a> <a class="code" href="classMultiTrack.html">MultiTrack</a>* <a class="code" href="classSound.html#a6">Sound::render</a>(
00150     <span class="keywordtype">int</span> numChannels,
00151     <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00152     <span class="comment">// Remember, the default value for samplingRate (as defined in the</span>
00153     <span class="comment">//  .h file is DEFAULT_SAMPLING_RATE</span>
00154 {
00155     <span class="comment">//------------------</span>
00156     <span class="comment">// calculate loudness for this sound.</span>
00157     <span class="comment">//------------------</span>
00158 
00159     <span class="comment">// negative loudness values signify that</span>
00160     <span class="comment">// loudness is not to be calculated for this sound.</span>
00161     <span class="keywordflow">if</span> (<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a2">LOUDNESS</a>) &gt;= 0)
00162     {
00163         cout &lt;&lt; <span class="stringliteral">"\t Calculating Loudness..."</span> &lt;&lt; endl;
00164         <a class="code" href="Types_8h.html#a4">m_rate_type</a> loudnessRate = <a class="code" href="Types_8h.html#a4">m_rate_type</a>(<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a3">LOUDNESS_RATE</a>));
00165         <span class="comment">//Loudness::calculate(*this, loudnessRate);</span>
00166            
00167 
00168 
00169 
00170 
00171 
00172 
00173 
00174 
00175 
00176         cout &lt;&lt; <span class="stringliteral">"rendering made it this far"</span> &lt;&lt; endl;
00177 
00178 
00179 
00180 
00181 
00182 
00183 
00184 
00185 
00186 
00187 
00188 
00189 
00190 
00191 
00192 
00193 
00194 
00195 
00196         <a class="code" href="classLoudness.html#e0">Loudness::calculate</a>(*<span class="keyword">this</span>);
00197     }
00198 
00199     <span class="comment">//------------------</span>
00200     <span class="comment">// do the detuning setup </span>
00201     <span class="comment">//------------------</span>
00202     <span class="keywordflow">if</span> (<a class="code" href="classCollection.html#a10">size</a>() != 0)
00203     {
00204         cout &lt;&lt; <span class="stringliteral">"\t Creating Envelopes..."</span> &lt;&lt; endl;
00205         <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> iter = <a class="code" href="classCollection.html#a12">iterator</a>();
00206 
00207         <span class="comment">// create the detuning envelope for this partial</span>
00208         <a class="code" href="classExponentialInterpolator.html">ExponentialInterpolator</a> detuning_env;
00209         <a class="code" href="classSound.html#d0">setup_detuning_env</a>(&amp;detuning_env);
00210         <span class="keywordflow">if</span>(<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a7">DETUNE_FUNDAMENTAL</a>) &gt; 0.0)
00211                 iter.<a class="code" href="classIterator.html#a5">next</a>().setParam(<a class="code" href="Partial_8h.html#a20a12">DETUNING_ENV</a>,detuning_env);
00212         iter.<a class="code" href="classIterator.html#a5">next</a>();
00213         
00214         <a class="code" href="classTrack.html">Track</a>* tempTrack;
00215         <span class="keywordflow">while</span>(iter.<a class="code" href="classIterator.html#a4">hasNext</a>())
00216         {
00217             <span class="comment">// create the detuning envelope for this partial</span>
00218             <a class="code" href="classExponentialInterpolator.html">ExponentialInterpolator</a> detuning_env;
00219             <a class="code" href="classSound.html#d0">setup_detuning_env</a>(&amp;detuning_env);
00220             iter.<a class="code" href="classIterator.html#a5">next</a>().setParam(<a class="code" href="Partial_8h.html#a20a12">DETUNING_ENV</a>,detuning_env);
00221         }
00222     }
00223     
00224 
00225     <span class="comment">//------------------</span>
00226     <span class="comment">// render each partial, and composite into a single track.</span>
00227     <span class="comment">//------------------</span>
00228 
00229     cout &lt;&lt; <span class="stringliteral">"\t Rendering..."</span> &lt;&lt; endl;
00230 
00231     <span class="comment">/*</span>
00232 <span class="comment">     * duration gets tricky when you've got partials and sounds, either or both</span>
00233 <span class="comment">     * of which can have different reverb applied.  'duration' refers to the</span>
00234 <span class="comment">     * 'dry' duration of this sound.  This is analogous to the length of time an</span>
00235 <span class="comment">     * instrument is buzzing a noise.  This is the duration of time we are</span>
00236 <span class="comment">     * generating sine waves in the partial.  After 'duration', each partial may</span>
00237 <span class="comment">     * or may not have reverb applied to it, and the overall sound may have</span>
00238 <span class="comment">     * reverb (potentially on top -- meaning, in addition to -- the partials'</span>
00239 <span class="comment">     * reverb.</span>
00240 <span class="comment">     *</span>
00241 <span class="comment">     * in contrast, getTotalDuration() returns the total audible length of time</span>
00242 <span class="comment">     * during which this sound, its partials, and any reverb will produce noise.</span>
00243 <span class="comment">     */</span>
00244     <a class="code" href="Types_8h.html#a2">m_time_type</a> duration = <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>);
00245 
00246     <span class="comment">// compute # of samples, taking into account space for reverb die-out</span>
00247     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> sampleCount;
00248     sampleCount = (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a>) ((<a class="code" href="Types_8h.html#a2">m_time_type</a>)<a class="code" href="classSound.html#a11">getTotalDuration</a>() * (<a class="code" href="Types_8h.html#a2">m_time_type</a>)samplingRate);
00249 
00250     <a class="code" href="classTrack.html">Track</a>* composite;
00251 
00252     <span class="keywordflow">if</span> (<a class="code" href="classCollection.html#a10">size</a>() == 0)
00253     {
00254         <span class="comment">// there are no partials</span>
00255         <span class="comment">// create a new empty track:</span>
00256         composite = <span class="keyword">new</span> <a class="code" href="classTrack.html">Track</a>(sampleCount, samplingRate);
00257         <span class="comment">// should we zero this memory out?</span>
00258     }
00259     <span class="keywordflow">else</span>
00260     {
00261         <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> iter = <a class="code" href="classCollection.html#a12">iterator</a>();
00262         composite = iter.<a class="code" href="classIterator.html#a5">next</a>().render(sampleCount, duration, samplingRate);
00263 
00264         <a class="code" href="classTrack.html">Track</a>* tempTrack;
00265         <span class="keywordflow">while</span>(iter.<a class="code" href="classIterator.html#a4">hasNext</a>())
00266         {
00267             tempTrack = iter.<a class="code" href="classIterator.html#a5">next</a>().render(sampleCount, duration, samplingRate);
00268             composite-&gt;<a class="code" href="classTrack.html#a8">composite</a>(*tempTrack);
00269             <span class="keyword">delete</span> tempTrack;
00270         }
00271     }
00272 
00273         <span class="comment">// do the reverb</span>
00274         <span class="keywordflow">if</span>(<a class="code" href="classSound.html#r1">reverbObj</a> != NULL)
00275         {
00276                 cout &lt;&lt; <span class="stringliteral">"\t Applying Reverb..."</span> &lt;&lt; endl;
00277                 <a class="code" href="classTrack.html">Track</a> &amp;reverbedTrack = <a class="code" href="classSound.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a9">do_reverb_Track</a>(*composite);
00278                 <span class="keyword">delete</span> composite;
00279 
00280                 <span class="comment">//------------------</span>
00281                 <span class="comment">// spatialize the sound into a MultiTrack object</span>
00282                 <span class="comment">//------------------</span>
00283 
00284                 cout &lt;&lt; <span class="stringliteral">"\t Spatializing..."</span> &lt;&lt; endl;
00285                 <a class="code" href="classMultiTrack.html">MultiTrack</a>* mt = <a class="code" href="classSound.html#r0">spatializer_</a>-&gt;<a class="code" href="classSpatializer.html#a0">spatialize</a>(reverbedTrack, numChannels);
00286 
00287                 <span class="comment">// delete the temporary track object that held the unspatialized reverbed sound</span>
00288                 <span class="keyword">delete</span> &amp;reverbedTrack;
00289 
00290                 <span class="keywordflow">return</span> mt;
00291         }
00292         <span class="keywordflow">else</span>
00293         {
00294                 <span class="comment">//------------------</span>
00295                 <span class="comment">// spatialize the sound into a MultiTrack object</span>
00296                 <span class="comment">//------------------</span>
00297 
00298                 cout &lt;&lt; <span class="stringliteral">"\t Spatializing..."</span> &lt;&lt; endl;
00299                 <a class="code" href="classMultiTrack.html">MultiTrack</a>* mt = <a class="code" href="classSound.html#r0">spatializer_</a>-&gt;<a class="code" href="classSpatializer.html#a0">spatialize</a>(*composite, numChannels);
00300                 <span class="keyword">delete</span> composite;
00301                 <span class="keywordflow">return</span> mt;
00302         }
00303 }
00304 
00305 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00306"></a><a class="code" href="classSound.html#a7">00306</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a7">Sound::setSpatializer</a>(<a class="code" href="classSpatializer.html">Spatializer</a>&amp; s)
00307 {
00308     <span class="keyword">delete</span> <a class="code" href="classSound.html#r0">spatializer_</a>;
00309     <a class="code" href="classSound.html#r0">spatializer_</a> = s.<a class="code" href="classSpatializer.html#a1">clone</a>();
00310 }
00311 
00312 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00313"></a><a class="code" href="classSound.html#a8">00313</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a8">Sound::use_reverb</a>(<a class="code" href="classReverb.html">Reverb</a> *newReverbObj)
00314 {
00315         <a class="code" href="classSound.html#r1">reverbObj</a> = newReverbObj;
00316 }
00317 
00318 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00319"></a><a class="code" href="classSound.html#d0">00319</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#d0">Sound::setup_detuning_env</a>(<a class="code" href="classExponentialInterpolator.html">ExponentialInterpolator</a> *detuning_env)
00320 {
00321         <span class="keywordtype">float</span> x[3], y[3], spread, vel;
00322 
00323         <span class="comment">// determine the shape of the envelope</span>
00324         vel = <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a6">DETUNE_VELOCITY</a>);
00325         x[0] = 0.0;
00326         y[0] = 1.0;
00327 
00328         x[1] = (((vel*0.95)+1.0)/2.0);
00329         y[1] = x[1]; 
00330         
00331         x[2] = 1.0;
00332         y[2] = 0.0;
00333 
00334         <span class="comment">// scale by the height spread of the envelope</span>
00335         spread = (<span class="keywordtype">float</span>)random() / (<span class="keywordtype">float</span>)RAND_MAX * <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>) * 2.0;
00336         spread = spread - <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>);
00337 
00338         y[0] *= spread;
00339         y[1] *= spread;
00340         x[1] *= spread;
00341         y[2] *= spread;
00342 
00343         <span class="comment">// then offset to normalize the whole thing at 1.0</span>
00344         y[0] += 1.0;
00345         y[1] += 1.0;
00346         y[2] += 1.0;
00347 
00348         <span class="keywordflow">if</span>(<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a5">DETUNE_DIRECTION</a>) &lt; 0.0) <span class="comment">// divergence (detuning)</span>
00349         {
00350                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[2], y[2]);
00351                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[1], y[1]);
00352                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[0], y[0]);
00353         }
00354         <span class="keywordflow">else</span> <span class="comment">// convergence (tuning)</span>
00355         {
00356                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[0], y[0]);
00357                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[1], y[1]);
00358                 detuning_env-&gt;<a class="code" href="classInterpolator.html#a2">addEntry</a>(x[2], y[2]);
00359         }
00360 }
00361 
00362 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00363"></a><a class="code" href="classSound.html#a11">00363</a> <a class="code" href="Types_8h.html#a2">m_time_type</a> <a class="code" href="classSound.html#a11">Sound::getTotalDuration</a>(<span class="keywordtype">void</span>)
00364 {
00365         <a class="code" href="Types_8h.html#a2">m_time_type</a> curDuration, maxDuration;
00366         <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> iter = <a class="code" href="classCollection.html#a12">iterator</a>();
00367 
00368         maxDuration = <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>);
00369         <span class="keywordflow">while</span>(iter.<a class="code" href="classIterator.html#a4">hasNext</a>())
00370         {
00371                 curDuration = iter.<a class="code" href="classIterator.html#a5">next</a>().getTotalDuration(<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>));
00372                 <span class="keywordflow">if</span>(curDuration &gt; maxDuration)
00373                         maxDuration = curDuration;
00374         }
00375 
00376         maxDuration += ( (<a class="code" href="classSound.html#r1">reverbObj</a> != NULL) ? <a class="code" href="classSound.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a11">getDecay</a>() : 0.0);
00377 
00378         <span class="keywordflow">return</span> maxDuration;
00379 }
00380 
00381 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00382"></a><a class="code" href="classSound.html#a9">00382</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a9">Sound::xml_print</a>( ofstream&amp; xmlOutput, list&lt;Reverb*&gt;&amp; revObjs, list&lt;DynamicVariable*&gt;&amp; dynObjs )
00383 {
00384         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;sound&gt;"</span> &lt;&lt; endl;
00385 
00386         <span class="comment">// Output reverb ID and update reverb collection if necessary</span>
00387         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;reverb_ptr id=\""</span> &lt;&lt; (<span class="keywordtype">long</span>)<a class="code" href="classSound.html#r1">reverbObj</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00388         list&lt;Reverb*&gt;::const_iterator revit;
00389         
00390         <span class="keywordflow">for</span>( revit=revObjs.begin(); revit != revObjs.end(); revit++ )
00391         {
00392                 <span class="keywordflow">if</span>( (*revit) == <a class="code" href="classSound.html#r1">reverbObj</a> )
00393                         <span class="keywordflow">break</span>;
00394         }
00395         <span class="keywordflow">if</span>( revit == revObjs.end() ){
00396                 revObjs.push_back( <a class="code" href="classSound.html#r1">reverbObj</a> );
00397         }
00398 
00399         <span class="comment">// Static Parameters</span>
00400         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;duration value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl; 
00401         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;start_time value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00402         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;loudness value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a2">LOUDNESS</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00403         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;loudness_rate value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a3">LOUDNESS_RATE</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00404         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;detune_spread value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00405         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;detune_direction value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a5">DETUNE_DIRECTION</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00406         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;detune_velocity value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a6">DETUNE_VELOCITY</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00407         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;detune_fundamental value=\""</span> &lt;&lt; <a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a7">DETUNE_FUNDAMENTAL</a>) &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00408 
00409         <span class="comment">//Dynamic Parameters</span>
00410         <a class="code" href="classSound.html#r0">spatializer_</a>-&gt;<a class="code" href="classSpatializer.html#a2">xml_print</a>( xmlOutput );
00411         
00412         <span class="comment">// Output XML for partials</span>
00413         <a class="code" href="classIterator.html">Iterator&lt;Partial&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00414         <span class="keywordflow">while</span>(it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00415     {
00416                 it.<a class="code" href="classIterator.html#a5">next</a>().xml_print( xmlOutput, revObjs, dynObjs );
00417         }
00418 
00419         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;/sound&gt;"</span> &lt;&lt; endl;
00420 }
00421 
<a name="l00422"></a><a class="code" href="classSound.html#a10">00422</a> <span class="keywordtype">void</span> <a class="code" href="classSound.html#a10">Sound::xml_read</a>(<a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a>* soundtag, hash_map&lt;long, Reverb *&gt;* reverbHash, hash_map&lt;long, DynamicVariable *&gt;* dvHash)
00423 {
00424         <span class="keywordflow">if</span>(strcmp(<span class="stringliteral">"sound"</span>,soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>))
00425         {
00426                 printf(<span class="stringliteral">"Not a sound tag?!  This is a %s tag!\n"</span>,soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>);
00427                 <span class="keywordflow">return</span>;
00428         }
00429 
00430         <span class="keywordtype">char</span> *value;
00431         
00432         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"reverb_ptr"</span>,<span class="stringliteral">"id"</span>))
00433         {
00434                 <span class="keywordtype">long</span> id=atoi(value);
00435                 <a class="code" href="classReverb.html">Reverb</a> * temp;
00436                 temp = (*reverbHash)[id];
00437                 
00438                 <span class="keywordflow">if</span>(temp != NULL)
00439                 {
00440                         <a class="code" href="classSound.html#a8">use_reverb</a>(temp);
00441                 }
00442         }
00443 
00444         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"duration"</span>,<span class="stringliteral">"value"</span>))
00445         {
00446                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a1">DURATION</a>, atof(value));
00447         }
00448 
00449         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"start_time"</span>,<span class="stringliteral">"value"</span>))
00450         {
00451                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>, atof(value));
00452         }
00453 
00454         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"loudness"</span>,<span class="stringliteral">"value"</span>))
00455         {
00456                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a2">LOUDNESS</a>, atof(value));
00457         }
00458         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"loudness_rate"</span>,<span class="stringliteral">"value"</span>))
00459         {
00460                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a3">LOUDNESS_RATE</a>, atof(value));
00461         }
00462         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"detune_spread"</span>,<span class="stringliteral">"value"</span>))
00463         {
00464                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a4">DETUNE_SPREAD</a>, atof(value));
00465         }
00466         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"detune_direction"</span>,<span class="stringliteral">"value"</span>))
00467         {
00468                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a5">DETUNE_DIRECTION</a>, atof(value));
00469         }
00470         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"detune_velocity"</span>,<span class="stringliteral">"value"</span>))
00471         {
00472                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a6">DETUNE_VELOCITY</a>, atof(value));
00473         }
00474         <span class="keywordflow">if</span>(value=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"detune_fundamental"</span>,<span class="stringliteral">"value"</span>))
00475         {
00476                 <a class="code" href="classParameterLib.html#a4">setParam</a>(<a class="code" href="Sound_8h.html#a8a7">DETUNE_FUNDAMENTAL</a>, atof(value));
00477         }
00478 
00479         <a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a> *partialtag;
00480 
00481         <span class="keywordflow">while</span>(partialtag=soundtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"partial"</span>))
00482         {
00483                 <a class="code" href="classPartial.html">Partial</a> p;
00484                 p.<a class="code" href="classPartial.html#a4">xml_read</a>(partialtag, reverbHash, dvHash);
00485                 <a class="code" href="classCollection.html#a4">add</a>(p);
00486         }
00487 }
00488 
00489 <span class="comment">//----------------------------------------------------------------------------//</span>
00490 <span class="preprocessor">#endif //__SOUND_H</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 13:18:12 2005 for LASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
