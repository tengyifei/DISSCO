<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LASS: AuWriter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>AuWriter.cpp</h1><a href="AuWriter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">LASS (additive sound synthesis library)</span>
00003 <span class="comment">Copyright (C) 2005  Sever Tipei (s-tipei@uiuc.edu)</span>
00004 <span class="comment"></span>
00005 <span class="comment">This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">modify it under the terms of the GNU General Public License</span>
00007 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00008 <span class="comment">of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment">GNU General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">along with this program; if not, write to the Free Software</span>
00017 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="comment">//----------------------------------------------------------------------------//</span>
00021 <span class="comment">//</span>
00022 <span class="comment">//      AuWriter.cpp</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//----------------------------------------------------------------------------//</span>
00025 
00026 <span class="preprocessor">#ifndef __AU_WRITER_CPP</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define __AU_WRITER_CPP</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//----------------------------------------------------------------------------//</span>
00030 
00031 <span class="preprocessor">#include &lt;cstdarg&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="AuWriter_8h.html">AuWriter.h</a>"</span>
00033 
00034 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00035"></a><a class="code" href="classAuWriter.html#e0">00035</a> <span class="keywordtype">bool</span> <a class="code" href="classAuWriter.html#e0">AuWriter::write</a>(<a class="code" href="classSoundSample.html">SoundSample</a>&amp; ss, string filename)
00036 {
00037     vector&lt;SoundSample*&gt; channels;
00038     channels.push_back(&amp;ss);
00039     <span class="keywordflow">return</span> <a class="code" href="classAuWriter.html#e0">write</a>(channels, filename);
00040 }
00041 
00042 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00043"></a><a class="code" href="classAuWriter.html#e1">00043</a> <span class="keywordtype">bool</span> <a class="code" href="classAuWriter.html#e0">AuWriter::write</a>(<a class="code" href="classTrack.html">Track</a>&amp; t, string filename)
00044 {
00045     vector&lt;SoundSample*&gt; channels;
00046     channels.push_back(&amp;t.<a class="code" href="classTrack.html#a5">getWave</a>());
00047     <span class="keywordflow">return</span> <a class="code" href="classAuWriter.html#e0">write</a>(channels, filename);
00048 }
00049 
00050 
00051 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00052"></a><a class="code" href="classAuWriter.html#e2">00052</a> <span class="keywordtype">bool</span> <a class="code" href="classAuWriter.html#e0">AuWriter::write</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>&amp; mt, string filename)
00053 {
00054     vector&lt;SoundSample*&gt; channels;
00055 
00056     <a class="code" href="classIterator.html">Iterator&lt;Track*&gt;</a> it = mt.<a class="code" href="classCollection.html#a12">iterator</a>();
00057     <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00058     {
00059         channels.push_back(&amp; it.<a class="code" href="classIterator.html#a5">next</a>()-&gt;getWave());
00060     }
00061 
00062     <span class="keywordflow">return</span> <a class="code" href="classAuWriter.html#e0">write</a>(channels, filename);
00063 }
00064 
00065 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00066"></a><a class="code" href="classAuWriter.html#e3">00066</a> <span class="keywordtype">bool</span> <a class="code" href="classAuWriter.html#e3">AuWriter::write_one_per_track</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>&amp; mt, <span class="keywordtype">char</span> *filename, ...)
00067 {
00068         vector&lt;SoundSample*&gt; channels;
00069         va_list marker;
00070 
00071         <span class="keywordtype">bool</span> ret_val = <span class="keyword">true</span>;
00072         <span class="keywordtype">char</span> *cur_filename = filename;
00073         <a class="code" href="classIterator.html">Iterator&lt;Track*&gt;</a> it = mt.<a class="code" href="classCollection.html#a12">iterator</a>();
00074 
00075         va_start(marker, filename);
00076         <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00077         {
00078                 channels.push_back(&amp; it.<a class="code" href="classIterator.html#a5">next</a>()-&gt;getWave());
00079                 ret_val = ret_val &amp; <a class="code" href="classAuWriter.html#e0">write</a>(channels, string(cur_filename));
00080                 channels.pop_back();
00081                 cur_filename = va_arg(marker, <span class="keywordtype">char</span> *);
00082         }
00083         va_end(marker);
00084 
00085         <span class="keywordflow">return</span> ret_val;
00086 }
00087 
00088 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00089"></a><a class="code" href="classAuWriter.html#h0">00089</a> <span class="keywordtype">bool</span> <a class="code" href="classAuWriter.html#e0">AuWriter::write</a>(vector&lt;SoundSample*&gt;&amp; channels, string filename)
00090 {
00091     <span class="comment">// ensure that all of the SoundSamples, have the same samplingRate.</span>
00092     <span class="comment">// Also, find the lowest sampleCount value of all the SoundSamples.</span>
00093     <span class="comment">// warn if sections of other SoundSamples are going to be clipped</span>
00094     <span class="comment">// because of this.</span>
00095     
00096     <span class="keywordtype">int</span> numChannels = channels.size();
00097     
00098     <span class="keywordflow">if</span> (numChannels == 0)
00099     {
00100         cout &lt;&lt; <span class="stringliteral">"ERROR: AuWriter: numChannels = 0"</span> &lt;&lt; endl;
00101         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00102     }
00103     
00104     <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate = channels[0]-&gt;getSamplingRate();
00105     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = channels[0]-&gt;getSampleCount();
00106     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> maxSamples = numSamples;
00107     
00108     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> c=0; c&lt;numChannels; c++)
00109     {
00110         <span class="comment">// make sure every channel has the same sampling rate</span>
00111         <span class="keywordflow">if</span> (channels[c]-&gt;getSamplingRate() != samplingRate)
00112         {
00113             cerr &lt;&lt; <span class="stringliteral">"ERROR: AuWriter: not all channels "</span>
00114                  &lt;&lt; <span class="stringliteral">"have the same sampling rate"</span> &lt;&lt; endl;
00115             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00116         }
00117         
00118         <span class="comment">// check the number of samples</span>
00119         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> count = channels[0]-&gt;getSampleCount();
00120         <span class="keywordflow">if</span> (count &lt; numSamples) numSamples = count;
00121         <span class="keywordflow">if</span> (count &gt; maxSamples) maxSamples = count;
00122     }
00123     
00124     <span class="keywordflow">if</span> (maxSamples &gt; numSamples)
00125     {
00126         <a class="code" href="Types_8h.html#a2">m_time_type</a> secondsClipped =
00127          ((<a class="code" href="Types_8h.html#a2">m_time_type</a>)(maxSamples - numSamples)) /
00128          ((<a class="code" href="Types_8h.html#a2">m_time_type</a>)samplingRate);
00129          
00130         cerr &lt;&lt; <span class="stringliteral">"WARNING: AuWriter: "</span> 
00131              &lt;&lt; <span class="stringliteral">"Because not all SoundSamples were of the same length, "</span> &lt;&lt; endl
00132              &lt;&lt; secondsClipped &lt;&lt; <span class="stringliteral">" seconds will be clipped off of the "</span>
00133              &lt;&lt; <span class="stringliteral">"end of one or more channels."</span> &lt;&lt; endl;
00134     }
00135     
00136     
00137     cout &lt;&lt; <span class="stringliteral">"Writing "</span> &lt;&lt; numSamples &lt;&lt; <span class="stringliteral">" samples at "</span> &lt;&lt; samplingRate 
00138          &lt;&lt; <span class="stringliteral">" Hz to file "</span> &lt;&lt; filename
00139          &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; numChannels &lt;&lt; <span class="stringliteral">" channels, "</span> 
00140          &lt;&lt; (numSamples / samplingRate) &lt;&lt; <span class="stringliteral">" sec)"</span> &lt;&lt; endl;
00141     
00142     <span class="comment">// now, we are ready to output the file.</span>
00143     
00144     <span class="comment">// try to open an output stream to filename</span>
00145     ofstream file;
00146     file.open(filename.c_str());
00147     
00148     <span class="comment">//--------------------</span>
00149     <span class="comment">// start of HEADER</span>
00150     
00151     file.write(<span class="stringliteral">".snd"</span>,4); <span class="comment">// magic string</span>
00152     
00153     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, 28L, 4); <span class="comment">// Length of header</span>
00154 
00155     <span class="comment">// length of sound (just really long, players stop at end of file)</span>
00156     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, 0x7FFFFFFFL, 4);
00157     
00158     <span class="comment">// file format : 16 bit linear</span>
00159     <span class="keywordtype">int</span> _16_BIT_LINEAR = 3;
00160     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, _16_BIT_LINEAR, 4);  
00161     
00162     <span class="comment">// sampling rate</span>
00163     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, samplingRate, 4);
00164 
00165     <span class="comment">// number of channels</span>
00166     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, numChannels, 4);
00167 
00168     <span class="comment">// padding before the data:</span>
00169     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, 0, 4); 
00170     
00171     <span class="comment">// end of HEADER</span>
00172     <span class="comment">//--------------------</span>
00173 
00174     <a class="code" href="Types_8h.html#a0">m_sample_type</a> sample;
00175     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> outOfBounds = 0;
00176     <span class="keywordtype">int</span> value;
00177 
00178     <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00179     {
00180         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> c=0; c&lt;numChannels; c++)
00181         {
00182             <span class="comment">// get the sample:</span>
00183             sample = (*channels[c])[s];
00184         
00185             <span class="comment">// check bounds:</span>
00186             <span class="keywordflow">if</span> (sample &gt; 1.0) {sample = 1.0; outOfBounds++;}
00187             <span class="keywordflow">if</span> (sample &lt; -1.0) {sample = -1.0; outOfBounds++;}
00188             
00189             <span class="comment">// convert the doubles to integer values</span>
00190             <span class="comment">// 16 bit sound (this number is 2^16/2 - 1)</span>
00191             value = (<span class="keywordtype">int</span>) ((sample) * 32767.0);
00192             
00193             <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(file, value, 2);
00194         }
00195     }
00196 
00197     
00198     <span class="comment">// warn on outOfBounds</span>
00199     <span class="keywordflow">if</span> (outOfBounds &gt; 0)
00200     {
00201         <a class="code" href="Types_8h.html#a2">m_time_type</a> secondsClipped =
00202          ((<a class="code" href="Types_8h.html#a2">m_time_type</a>)outOfBounds) /
00203          ((<a class="code" href="Types_8h.html#a2">m_time_type</a>)samplingRate);
00204          
00205         cerr &lt;&lt; <span class="stringliteral">"WARNING: AuWriter: "</span>
00206              &lt;&lt; outOfBounds &lt;&lt; <span class="stringliteral">" samples "</span>
00207              &lt;&lt; <span class="stringliteral">"("</span> &lt;&lt; secondsClipped &lt;&lt; <span class="stringliteral">" seconds) "</span>
00208              &lt;&lt; <span class="stringliteral">"contained values that clipped."</span> &lt;&lt; endl;
00209     }
00210     
00211     file.close();
00212     
00213     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00214 }
00215 
00216 
00217 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00218"></a><a class="code" href="classAuWriter.html#h1">00218</a> <span class="keywordtype">void</span> <a class="code" href="classAuWriter.html#h1">AuWriter::WriteIntMsb</a>(ostream &amp;out, <span class="keywordtype">long</span> l, <span class="keywordtype">int</span> size) {
00219     <span class="keywordflow">if</span> (size &lt;= 0) <span class="keywordflow">return</span>;
00220     <a class="code" href="classAuWriter.html#h1">WriteIntMsb</a>(out, l&gt;&gt;8, size-1); <span class="comment">// Write MS Bytes</span>
00221     out.put(l&amp;255); <span class="comment">// Write LS Byte</span>
00222 }
00223     
00224 <span class="comment">//----------------------------------------------------------------------------//</span>
00225 <span class="preprocessor">#endif //__AU_WRITER_CPP</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 13:18:11 2005 for LASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
