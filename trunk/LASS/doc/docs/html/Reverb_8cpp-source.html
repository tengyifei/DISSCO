<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LASS: Reverb.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Reverb.cpp</h1><a href="Reverb_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">LASS (additive sound synthesis library)</span>
00003 <span class="comment">Copyright (C) 2005  Sever Tipei (s-tipei@uiuc.edu)</span>
00004 <span class="comment"></span>
00005 <span class="comment">This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">modify it under the terms of the GNU General Public License</span>
00007 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00008 <span class="comment">of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment">GNU General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">along with this program; if not, write to the Free Software</span>
00017 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="comment">//----------------------------------------------------------------------------//</span>
00021 <span class="comment">//</span>
00022 <span class="comment">//      Reverb.cpp</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//----------------------------------------------------------------------------//</span>
00025 
00026 <span class="comment">/* Best if viewed with 4-space tabs */</span>
00027 
00028 <span class="preprocessor">#ifndef __REVERB_CPP</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#define __REVERB_CPP</span>
00030 <span class="preprocessor"></span>
00031 <span class="comment">//----------------------------------------------------------------------------//</span>
00032 
00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
00034 <span class="preprocessor">#include "<a class="code" href="SoundSample_8h.html">SoundSample.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="code" href="Collection_8h.html">Collection.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="Track_8h.html">Track.h</a>"</span>
00037 <span class="preprocessor">#include "<a class="code" href="MultiTrack_8h.html">MultiTrack.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="LPCombFilter_8h.html">LPCombFilter.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="AllPassFilter_8h.html">AllPassFilter.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="Reverb_8h.html">Reverb.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="Types_8h.html">Types.h</a>"</span>
00042 
00043 <span class="comment">//----------------------------------------------------------------------------//</span>
00044 
00045 
<a name="l00049"></a><a class="code" href="classReverb.html#a0">00049</a> <a class="code" href="classReverb.html#a0">Reverb::Reverb</a>(<a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00050 {
00051         <span class="keywordtype">float</span> comb_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00052         <span class="keywordtype">float</span> lp_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00053         <span class="keywordtype">int</span> i;
00054 
00055         comb_gain_list[0] = 0.46;
00056         comb_gain_list[1] = 0.48;
00057         comb_gain_list[2] = 0.50;
00058         comb_gain_list[3] = 0.52;
00059         comb_gain_list[4] = 0.53;
00060         comb_gain_list[5] = 0.55;
00061 
00062         <span class="keywordtype">float</span> hi_low_spread = 0.05;
00063         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00064                 lp_gain_list[i] = 0.05 + (hi_low_spread * (0.95 - comb_gain_list[i]));
00065 
00066         <a class="code" href="classReverb.html#a4">ConstructorCommon</a>(0.83, &amp;comb_gain_list[0], &amp;lp_gain_list[0], 
00067                         0.7, 0.6, samplingRate);
00068 }
00069 
<a name="l00070"></a><a class="code" href="classReverb.html#a1">00070</a> <a class="code" href="classReverb.html#a0">Reverb::Reverb</a>(<span class="keywordtype">float</span> room_size, <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00071 {
00072         <span class="keywordtype">float</span> comb_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00073         <span class="keywordtype">float</span> lp_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00074         <span class="keywordtype">int</span> i;
00075 
00076         <span class="keywordtype">float</span> percentReverb = 0.345 + (0.625 * room_size);
00077         <span class="keywordtype">float</span> hilow_spread  = 0.056 + (0.430 * room_size);
00078         <span class="keywordtype">float</span> gainAllPass   = 0.7;
00079         <span class="keywordtype">float</span> delay         = 0.176 + (0.233 * room_size);
00080 
00081         comb_gain_list[0] = 0.46;
00082         comb_gain_list[1] = 0.48;
00083         comb_gain_list[2] = 0.50;
00084         comb_gain_list[3] = 0.52;
00085         comb_gain_list[4] = 0.53;
00086         comb_gain_list[5] = 0.55;
00087 
00088         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00089                 lp_gain_list[i] = 0.05 + (hilow_spread * (0.95 - comb_gain_list[i]));
00090 
00091         <a class="code" href="classReverb.html#a4">ConstructorCommon</a>(percentReverb, &amp;comb_gain_list[0], &amp;lp_gain_list[0], 
00092                         gainAllPass, delay, samplingRate);
00093 }
00094         
<a name="l00095"></a><a class="code" href="classReverb.html#a2">00095</a> <a class="code" href="classReverb.html#a0">Reverb::Reverb</a>(<span class="keywordtype">float</span> percentReverb, <span class="keywordtype">float</span> hilow_spread, <span class="keywordtype">float</span> gainAllPass, 
00096                 <span class="keywordtype">float</span> delay, <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00097 {
00098         <span class="keywordtype">float</span> comb_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00099         <span class="keywordtype">float</span> lp_gain_list[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00100         <span class="keywordtype">int</span> i;
00101 
00102         comb_gain_list[0] = 0.46;
00103         comb_gain_list[1] = 0.48;
00104         comb_gain_list[2] = 0.50;
00105         comb_gain_list[3] = 0.52;
00106         comb_gain_list[4] = 0.53;
00107         comb_gain_list[5] = 0.55;
00108 
00109         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00110                 lp_gain_list[i] = 0.05 + (hilow_spread * (0.95 - comb_gain_list[i]));
00111 
00112         <a class="code" href="classReverb.html#a4">ConstructorCommon</a>(percentReverb, &amp;comb_gain_list[0], &amp;lp_gain_list[0], 
00113                         gainAllPass, delay, samplingRate);
00114 }
00115 
<a name="l00140"></a><a class="code" href="classReverb.html#a3">00140</a> <a class="code" href="classReverb.html#a0">Reverb::Reverb</a>(<span class="keywordtype">float</span> percentReverb, <span class="keywordtype">float</span> *combGainList, <span class="keywordtype">float</span> *lpGainList,
00141                 <span class="keywordtype">float</span> gainAllPass, <span class="keywordtype">float</span> delay, <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00142 {
00143         <a class="code" href="classReverb.html#a4">ConstructorCommon</a>(percentReverb, combGainList, lpGainList, gainAllPass, 
00144                         delay, samplingRate);
00145 }
00146 
<a name="l00179"></a><a class="code" href="classReverb.html#a4">00179</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a4">Reverb::ConstructorCommon</a>(<span class="keywordtype">float</span> percentReverb, <span class="keywordtype">float</span> *comb_gain_list,
00180                 <span class="keywordtype">float</span> *lp_gain_list, <span class="keywordtype">float</span> gainAllPass, <span class="keywordtype">float</span> delay, 
00181                 <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00182 {
00183         <span class="keywordtype">long</span> combdelay[<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>];
00184         <span class="keywordtype">int</span> i;
00185 
00186         <span class="comment">// figure out allpass filter parameters</span>
00187         <a class="code" href="classReverb.html#r1">gainReverb</a> = percentReverb;
00188         <a class="code" href="classReverb.html#r0">gainDirect</a> = 1 - percentReverb;
00189 
00190         combdelay[0] = (<span class="keywordtype">long</span>)(samplingRate*0.050);
00191         combdelay[1] = (<span class="keywordtype">long</span>)(samplingRate*0.056);
00192         combdelay[2] = (<span class="keywordtype">long</span>)(samplingRate*0.061);
00193         combdelay[3] = (<span class="keywordtype">long</span>)(samplingRate*0.068);
00194         combdelay[4] = (<span class="keywordtype">long</span>)(samplingRate*0.072);
00195         combdelay[5] = (<span class="keywordtype">long</span>)(samplingRate*0.078);
00196 
00197         <span class="comment">// Make comb filters (figure out low-pass gains better)</span>
00198         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00199         {
00200                 <a class="code" href="classReverb.html#r3">lpcfilter</a>[i] = <span class="keyword">new</span> <a class="code" href="classLPCombFilter.html">LPCombFilter</a>(comb_gain_list[i], combdelay[i], lp_gain_list[i]);
00201         }
00202 
00203         <span class="comment">// Make an all pass filter</span>
00204         <a class="code" href="classReverb.html#r2">allPassDelay</a> = delay;
00205         <a class="code" href="classReverb.html#r4">apfilter</a> = <span class="keyword">new</span> <a class="code" href="classAllPassFilter.html">AllPassFilter</a>(gainAllPass, (<span class="keywordtype">long</span>)((<a class="code" href="Types_8h.html#a2">m_time_type</a>)<a class="code" href="classReverb.html#r2">allPassDelay</a>*samplingRate) );
00206 
00207         <span class="comment">// Find the decay time</span>
00208         <span class="keywordtype">float</span> alpha = 0.0; <span class="comment">// alpha is the steady state gain (which is also the max of the gain fn</span>
00209 <span class="preprocessor">        #define max(x,y) ((x) &gt; (y) ? (x) : (y))</span>
00210 <span class="preprocessor"></span>        <span class="keywordflow">for</span>(i=0;i&lt;6;i++)
00211                 alpha = max(alpha, comb_gain_list[i]/(1.0 - lp_gain_list[i]));
00212         <span class="keywordtype">float</span> T_r = -3.0 * delay / log(alpha);
00213         <a class="code" href="classReverb.html#r5">decay_duration</a> = T_r*1.0;
00214 }
00215 
<a name="l00219"></a><a class="code" href="classReverb.html#a5">00219</a> <a class="code" href="classReverb.html#a5">Reverb::~Reverb</a>()
00220 {
00221         <span class="keywordtype">int</span> i;
00222         
00223         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00224                 <span class="keyword">delete</span> <a class="code" href="classReverb.html#r3">lpcfilter</a>[i];
00225 
00226         <span class="keyword">delete</span> <a class="code" href="classReverb.html#r4">apfilter</a>;
00227 }
00228 
<a name="l00232"></a><a class="code" href="classReverb.html#a6">00232</a> <a class="code" href="Types_8h.html#a0">m_sample_type</a> <a class="code" href="classReverb.html#a6">Reverb::do_reverb</a>(<a class="code" href="Types_8h.html#a0">m_sample_type</a> x_t)
00233 {
00234         <span class="keywordtype">int</span> i;
00235         <a class="code" href="Types_8h.html#a0">m_sample_type</a> y;
00236 
00237         <span class="comment">// run the sample through various comb filters (for effeciency</span>
00238         <span class="comment">// reasons, I hard coded this (instead of looping from 0 to</span>
00239         <span class="comment">// (REVERB_NUM_COMB_FILTERS-1).</span>
00240         y  = <a class="code" href="classReverb.html#r3">lpcfilter</a>[0]-&gt;<a class="code" href="classLPCombFilter.html#a2">do_filter</a>(x_t);
00241         y += lpcfilter[1]-&gt;do_filter(x_t);
00242         y += lpcfilter[2]-&gt;do_filter(x_t);
00243         y += lpcfilter[3]-&gt;do_filter(x_t);
00244         y += lpcfilter[4]-&gt;do_filter(x_t);
00245         y += lpcfilter[5]-&gt;do_filter(x_t);
00246         y /= (<a class="code" href="Types_8h.html#a0">m_sample_type</a>)<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;
00247 
00248         <span class="comment">// after adding up the results, run it through an allpass filter</span>
00249         y = <a class="code" href="classReverb.html#r4">apfilter</a>-&gt;<a class="code" href="classAllPassFilter.html#a2">do_filter</a>(y);
00250 
00251         <span class="comment">// Mix it with the input sound</span>
00252         y = (<a class="code" href="classReverb.html#r1">gainReverb</a>*y) + (<a class="code" href="classReverb.html#r0">gainDirect</a>*x_t);
00253 
00254         <span class="keywordflow">return</span> y;
00255 }
00256 
<a name="l00266"></a><a class="code" href="classReverb.html#a7">00266</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a7">Reverb::reset</a>(<span class="keywordtype">void</span>)
00267 {
00268         <span class="keywordtype">int</span> i;
00269 
00270         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>;i++)
00271                 <a class="code" href="classReverb.html#r3">lpcfilter</a>[i]-&gt;<a class="code" href="classLPCombFilter.html#a3">reset</a>();
00272         <a class="code" href="classReverb.html#r4">apfilter</a>-&gt;<a class="code" href="classAllPassFilter.html#a3">reset</a>();
00273 }
00274 
<a name="l00278"></a><a class="code" href="classReverb.html#a8">00278</a> <a class="code" href="classMultiTrack.html">MultiTrack</a> &amp;<a class="code" href="classReverb.html#a8">Reverb::do_reverb_MultiTrack</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a> &amp;inWave)
00279 {
00280         <a class="code" href="classMultiTrack.html">MultiTrack</a> *newMultiTrack;
00281         <a class="code" href="classSoundSample.html">SoundSample</a> *newWave, *newAmp;
00282 
00283         <span class="comment">// create the new MultiTrack</span>
00284         newMultiTrack = <span class="keyword">new</span> <a class="code" href="classMultiTrack.html">MultiTrack</a>();
00285 
00286         <span class="comment">// iterate over all individual tracks</span>
00287         <span class="comment">// for each track:</span>
00288         <span class="comment">//  grab the SoundSample from inside the Track</span>
00289         <span class="comment">//  filter the SoundSample, which returns a NEW SoundSample</span>
00290         <span class="comment">//  reset the filter so that it can be used fresh next time</span>
00291         <span class="comment">//  create a new track based on the returned, filtered SoundSample</span>
00292         <span class="comment">//  add this new track to the output MultiTrack</span>
00293         <a class="code" href="classIterator.html">Iterator&lt;Track*&gt;</a> it = inWave.<a class="code" href="classCollection.html#a12">iterator</a>();
00294         <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00295         {
00296                 <a class="code" href="classTrack.html">Track</a> *curTrack = it.<a class="code" href="classIterator.html#a5">next</a>();
00297 
00298                 newWave = <a class="code" href="classReverb.html#a10">do_reverb_SoundSample</a>(&amp;curTrack-&gt;<a class="code" href="classTrack.html#a5">getWave</a>());
00299                 <a class="code" href="classReverb.html#a7">reset</a>();
00300                 newAmp  = <a class="code" href="classReverb.html#d0">constructAmp</a>(newWave); 
00301                 <a class="code" href="classReverb.html#a7">reset</a>();
00302                 newMultiTrack-&gt;<a class="code" href="classCollection.html#a4">add</a>(<span class="keyword">new</span> <a class="code" href="classTrack.html">Track</a>(newWave, newAmp));
00303         }
00304 
00305         <span class="keywordflow">return</span> *newMultiTrack;
00306 }
00307 
<a name="l00311"></a><a class="code" href="classReverb.html#a9">00311</a> <a class="code" href="classTrack.html">Track</a> &amp;<a class="code" href="classReverb.html#a9">Reverb::do_reverb_Track</a>(<a class="code" href="classTrack.html">Track</a> &amp;inWave)
00312 {
00313         <a class="code" href="classTrack.html">Track</a> *newTrack;
00314         <a class="code" href="classSoundSample.html">SoundSample</a> *newWave, *newAmp;
00315 
00316         <span class="comment">// grab the SoundSample from inside the Track</span>
00317         <span class="comment">// filter the SoundSample, which returns a NEW SoundSample</span>
00318         <span class="comment">// create a new track based on the returned, filtered SoundSample</span>
00319         newWave = <a class="code" href="classReverb.html#a10">do_reverb_SoundSample</a>(&amp;inWave.<a class="code" href="classTrack.html#a5">getWave</a>());
00320         <a class="code" href="classReverb.html#a7">reset</a>();
00321         newAmp  = <a class="code" href="classReverb.html#d0">constructAmp</a>(newWave); 
00322         newTrack = <span class="keyword">new</span> <a class="code" href="classTrack.html">Track</a>(newWave, newAmp);
00323 
00324         <span class="keywordflow">return</span> *newTrack;
00325 }
00326 
<a name="l00330"></a><a class="code" href="classReverb.html#a10">00330</a> <a class="code" href="classSoundSample.html">SoundSample</a> *<a class="code" href="classReverb.html#a10">Reverb::do_reverb_SoundSample</a>(<a class="code" href="classSoundSample.html">SoundSample</a> *inWave)
00331 {
00332         <span class="keywordtype">int</span> i;
00333         <a class="code" href="classSoundSample.html">SoundSample</a> *outWave;
00334 
00335         <span class="comment">// create new SoundSample</span>
00336         outWave = <span class="keyword">new</span> <a class="code" href="classSoundSample.html">SoundSample</a>(inWave-&gt;<a class="code" href="classSoundSample.html#a6">getSampleCount</a>(),
00337                                                           inWave-&gt;<a class="code" href="classSoundSample.html#a5">getSamplingRate</a>());
00338 
00339         <span class="keywordflow">for</span>(i=0;i&lt;inWave-&gt;<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();i++)
00340                 (*outWave)[i] = <a class="code" href="classReverb.html#a6">do_reverb</a>((*inWave)[i]);
00341 
00342         <span class="keywordflow">return</span> outWave;
00343 }
00344 
<a name="l00349"></a><a class="code" href="classReverb.html#a11">00349</a> <span class="keywordtype">float</span> <a class="code" href="classReverb.html#a11">Reverb::getDecay</a>(<span class="keywordtype">void</span>)
00350 {
00351         <span class="keywordflow">return</span> <a class="code" href="classReverb.html#r5">decay_duration</a>*4.0; 
00352 }
00353 
<a name="l00379"></a><a class="code" href="classReverb.html#d0">00379</a> <a class="code" href="classSoundSample.html">SoundSample</a> *<a class="code" href="classReverb.html#d0">Reverb::constructAmp</a>(<a class="code" href="classSoundSample.html">SoundSample</a> *wave)
00380 {
00381         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> nSamples, windowRadius;
00382         <span class="keywordtype">long</span> ctr1, pos, maxAmpPos;
00383         <a class="code" href="Types_8h.html#a4">m_rate_type</a> sampRate;
00384         <a class="code" href="classSoundSample.html">SoundSample</a> *ampWave;
00385         <a class="code" href="Types_8h.html#a0">m_sample_type</a> maxAmp;
00386 
00387         <span class="comment">// initialize various variables</span>
00388         <span class="comment">// loop over all samples</span>
00389         nSamples = wave-&gt;<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00390         sampRate = wave-&gt;<a class="code" href="classSoundSample.html#a5">getSamplingRate</a>();
00391         ampWave = <span class="keyword">new</span> <a class="code" href="classSoundSample.html">SoundSample</a>(nSamples, sampRate, <span class="keyword">false</span>);
00392         windowRadius = (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a>) (1.0/20.0*sampRate / 2.0);
00393 
00394         <span class="comment">// find the initial max (over a window of plus/minus windowRadius,</span>
00395         <span class="comment">// with the center at index=0 of the wave SoundSample</span>
00396         maxAmp = (*wave)[0];
00397         maxAmpPos = 0;
00398         <span class="keywordflow">for</span>(ctr1=1; ctr1&lt;min(windowRadius,nSamples); ctr1++)
00399         {
00400                 <span class="keywordflow">if</span>((*wave)[ctr1] &gt; maxAmp)
00401                 {
00402                         maxAmp = (*wave)[ctr1];
00403                         maxAmpPos = ctr1;
00404                 }
00405         }
00406 
00407         <span class="comment">// loop over all samples</span>
00408         <span class="keywordflow">for</span>(; ctr1&lt;nSamples; ctr1++)
00409         {
00410                 <span class="comment">// has the old maximum gone out of range (too far to the left</span>
00411                 <span class="comment">//  of the window) ?</span>
00412                 <span class="keywordflow">if</span>(maxAmpPos &lt;= (ctr1 - windowRadius))
00413                 {
00414                         <span class="comment">// yes, so find a new maximum over the whole window</span>
00415                         maxAmp = 0.0;
00416                         <span class="keywordflow">for</span>(pos = max(ctr1-windowRadius,0); pos &lt; min(ctr1+windowRadius,nSamples); pos++)
00417                         {
00418                                 <span class="keywordflow">if</span>((*wave)[pos] &gt; maxAmp)
00419                                 {
00420                                         maxAmp = (*wave)[pos];
00421                                         maxAmpPos = pos;
00422                                 }
00423                         }
00424                 }
00425                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(maxAmp &lt; (*wave)[min(ctr1+windowRadius, nSamples)])
00426                 {
00427                         maxAmp = (*wave)[min(ctr1+windowRadius, nSamples)];
00428                         maxAmpPos = min(ctr1+windowRadius, nSamples);
00429                 }
00430                 (*ampWave)[ctr1] = maxAmp;
00431         }
00432 
00433         <span class="keywordflow">return</span> ampWave;
00434 }
00435 
<a name="l00440"></a><a class="code" href="classReverb.html#a12">00440</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a12">Reverb::xml_print</a>( ofstream&amp; xmlOutput )
00441 {
00442         <span class="keywordtype">int</span> i;
00443         <a class="code" href="classReverb.html">Reverb</a>* pnt2rev = <span class="keyword">this</span>;
00444 
00445     xmlOutput &lt;&lt; <span class="stringliteral">"&lt;reverb id=\""</span> &lt;&lt; (<span class="keywordtype">long</span>)pnt2rev &lt;&lt; <span class="stringliteral">"\"&gt;"</span> &lt;&lt; endl;
00446         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;gainDirect value=\""</span> &lt;&lt; <a class="code" href="classReverb.html#r0">gainDirect</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00447         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;gainReverb value=\""</span> &lt;&lt; <a class="code" href="classReverb.html#r1">gainReverb</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00448         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;allPassDelay value=\""</span> &lt;&lt; <a class="code" href="classReverb.html#r2">allPassDelay</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00449         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;decay_duration value=\""</span> &lt;&lt; <a class="code" href="classReverb.html#r5">decay_duration</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00450 
00451     <span class="comment">// XML for each LPCombFilter</span>
00452         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="Reverb_8h.html#a0">REVERB_NUM_COMB_FILTERS</a>; i++ )
00453         {
00454                 <a class="code" href="classReverb.html#r3">lpcfilter</a>[i]-&gt;<a class="code" href="classLPCombFilter.html#a4">xml_print</a>( xmlOutput );
00455         }
00456 
00457         <a class="code" href="classReverb.html#r4">apfilter</a>-&gt;<a class="code" href="classAllPassFilter.html#a4">xml_print</a>( xmlOutput );
00458     xmlOutput &lt;&lt; <span class="stringliteral">"&lt;/reverb&gt;"</span> &lt;&lt; endl;
00459 }
00460 
<a name="l00461"></a><a class="code" href="classReverb.html#a19">00461</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a19">Reverb::xml_read</a>(<a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a> *reverbtag)
00462 {
00463         
00464         <span class="comment">// Sanity Check</span>
00465         <span class="keywordflow">if</span>(strcmp(<span class="stringliteral">"reverb"</span>,reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>))
00466         {
00467                 printf(<span class="stringliteral">"Not a reverb tag!  This is a %s tag!\n"</span>,reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>);
00468                 <span class="keywordflow">return</span>;
00469         }
00470         
00471         <span class="keywordtype">char</span> *value;
00472         <span class="keywordflow">if</span>(value=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"gainDirect"</span>,<span class="stringliteral">"value"</span>))
00473         {
00474                 <a class="code" href="classReverb.html#a13">set_gainDirect</a>(atof(value));
00475         }
00476 
00477         <span class="keywordflow">if</span>(value=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"gainReverb"</span>,<span class="stringliteral">"value"</span>))
00478         {
00479                 <a class="code" href="classReverb.html#a14">set_gainReverb</a>(atof(value));
00480         }
00481         
00482         <span class="keywordflow">if</span>(value=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"allPassDelay"</span>,<span class="stringliteral">"value"</span>))
00483         {
00484                 <a class="code" href="classReverb.html#a15">set_allPassDelay</a>(atof(value));
00485         }
00486         
00487         <span class="keywordflow">if</span>(value=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"decay_duration"</span>,<span class="stringliteral">"value"</span>))
00488         {
00489                 <a class="code" href="classReverb.html#a16">set_decay_duration</a>(atof(value));
00490         }
00491         
00492         <a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a> *childtag;
00493         <span class="keywordtype">int</span> lpIndex = 0;
00494         <span class="keywordflow">while</span>(childtag=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"LPCombFilter"</span>))
00495         {
00496                 <a class="code" href="classLPCombFilter.html">LPCombFilter</a>* lp = <span class="keyword">new</span> <a class="code" href="classLPCombFilter.html">LPCombFilter</a>();
00497                 lp-&gt;<a class="code" href="classLPCombFilter.html#a9">xml_read</a>(childtag);
00498                 <a class="code" href="classReverb.html#a17">setLPComb</a>(lpIndex, lp);
00499                 lpIndex++;
00500         }
00501         
00502         <span class="keywordflow">while</span>(childtag=reverbtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"AllPassFilter"</span>))
00503         {
00504                 <a class="code" href="classAllPassFilter.html">AllPassFilter</a>* apf = <span class="keyword">new</span> <a class="code" href="classAllPassFilter.html">AllPassFilter</a>();
00505                 apf-&gt;<a class="code" href="classAllPassFilter.html#a8">xml_read</a>(childtag);
00506                 <a class="code" href="classReverb.html#a18">setAllPass</a>(apf);        
00507         }
00508 }
00509 
<a name="l00510"></a><a class="code" href="classReverb.html#a13">00510</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a13">Reverb::set_gainDirect</a>(<span class="keywordtype">float</span> new_gainDirect)
00511 {
00512         <a class="code" href="classReverb.html#r0">gainDirect</a> = new_gainDirect;
00513 }
<a name="l00514"></a><a class="code" href="classReverb.html#a14">00514</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a14">Reverb::set_gainReverb</a>(<span class="keywordtype">float</span> new_gainReverb)
00515 {
00516         <a class="code" href="classReverb.html#r1">gainReverb</a> = new_gainReverb;
00517 }
<a name="l00518"></a><a class="code" href="classReverb.html#a15">00518</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a15">Reverb::set_allPassDelay</a>(<span class="keywordtype">float</span> new_allPassDelay)
00519 {
00520         <a class="code" href="classReverb.html#r2">allPassDelay</a> = new_allPassDelay;
00521 }
<a name="l00522"></a><a class="code" href="classReverb.html#a16">00522</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a16">Reverb::set_decay_duration</a>(<span class="keywordtype">float</span> new_decay_duration)
00523 {
00524         <a class="code" href="classReverb.html#r5">decay_duration</a> = new_decay_duration;
00525 }
<a name="l00526"></a><a class="code" href="classReverb.html#a17">00526</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a17">Reverb::setLPComb</a>(<span class="keywordtype">int</span> idx, <a class="code" href="classLPCombFilter.html">LPCombFilter</a> *f)
00527 {
00528         <a class="code" href="classReverb.html#r3">lpcfilter</a>[idx] = f;
00529 }
<a name="l00530"></a><a class="code" href="classReverb.html#a18">00530</a> <span class="keywordtype">void</span> <a class="code" href="classReverb.html#a18">Reverb::setAllPass</a>(<a class="code" href="classAllPassFilter.html">AllPassFilter</a> *f)
00531 {
00532         <a class="code" href="classReverb.html#r4">apfilter</a> = f;
00533 }
00534 
00535 
00536 
00537 <span class="preprocessor">#endif //__REVERB_CPP</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 13:18:12 2005 for LASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
