<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LASS: MultiPan.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>MultiPan.cpp</h1><a href="MultiPan_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">LASS (additive sound synthesis library)</span>
00003 <span class="comment">Copyright (C) 2005  Sever Tipei (s-tipei@uiuc.edu)</span>
00004 <span class="comment"></span>
00005 <span class="comment">This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">modify it under the terms of the GNU General Public License</span>
00007 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00008 <span class="comment">of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment">GNU General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">along with this program; if not, write to the Free Software</span>
00017 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="comment">//----------------------------------------------------------------------------//</span>
00021 <span class="comment">//</span>
00022 <span class="comment">//      MultiPan.cpp    </span>
00023 <span class="comment">//</span>
00024 <span class="comment">//----------------------------------------------------------------------------//</span>
00025 <span class="preprocessor">#ifndef __MULTI_PAN_CPP</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#define __MULTI_PAN_CPP</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#include &lt;math.h&gt;</span>
00029 <span class="preprocessor">#include &lt;cstdarg&gt;</span>
00030 <span class="preprocessor">#include "<a class="code" href="Types_8h.html">Types.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="Spatializer_8h.html">Spatializer.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="MultiTrack_8h.html">MultiTrack.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="Track_8h.html">Track.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="Envelope_8h.html">Envelope.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="code" href="MultiPan_8h.html">MultiPan.h</a>"</span>
00036 
00037 <span class="comment">//----------------------------------------------------------------------------//</span>
00038 
<a name="l00049"></a><a class="code" href="classMultiPan.html#a0">00049</a> <a class="code" href="classMultiPan.html#a0">MultiPan::MultiPan</a>(<span class="keywordtype">int</span> nChans)
00050 {
00051         <span class="keywordtype">int</span> i;
00052 
00053         <a class="code" href="classMultiPan.html#r5">n_channels</a> = nChans;
00054         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="classMultiPan.html#r5">n_channels</a>;i++)
00055         {
00056                 <a class="code" href="classMultiPan.html#r1">EnvList</a>.push_back(NULL);
00057                 <a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>.push_back(<span class="keyword">new</span> <a class="code" href="classCollection.html">Collection&lt;xy_point&gt;</a>());
00058                 <a class="code" href="classMultiPan.html#r3">segCollectionsList</a>.push_back(<span class="keyword">new</span> <a class="code" href="classCollection.html">Collection&lt;envelope_segment&gt;</a>());
00059         }
00060         <a class="code" href="classMultiPan.html#r0">useEnvDirectly</a> = <span class="keyword">false</span>;
00061 }
00062    
<a name="l00077"></a><a class="code" href="classMultiPan.html#a1">00077</a> <a class="code" href="classMultiPan.html#a0">MultiPan::MultiPan</a>(<span class="keywordtype">int</span> nChans, vector&lt;Envelope*&gt; &amp;List)
00078 {
00079         <span class="keywordtype">int</span> i;
00080 
00081         <a class="code" href="classMultiPan.html#r5">n_channels</a> = nChans;
00082         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="classMultiPan.html#r5">n_channels</a>;i++)
00083                 <a class="code" href="classMultiPan.html#r1">EnvList</a>.push_back((List[i])-&gt;<a class="code" href="classMultiPan.html#a3">clone</a>());
00084         <a class="code" href="classMultiPan.html#r0">useEnvDirectly</a> = <span class="keyword">true</span>;
00085 }
00086    
<a name="l00090"></a><a class="code" href="classMultiPan.html#a2">00090</a> <a class="code" href="classMultiPan.html#a2">MultiPan::~MultiPan</a>()
00091 {
00092         <span class="keywordtype">int</span> i;
00093 
00094         <span class="keywordflow">while</span>(!<a class="code" href="classMultiPan.html#r1">EnvList</a>.empty())
00095         {
00096                 <a class="code" href="classEnvelope.html">Envelope</a> *l;
00097 
00098                 l = <a class="code" href="classMultiPan.html#r1">EnvList</a>.back();
00099                 <a class="code" href="classMultiPan.html#r1">EnvList</a>.pop_back();
00100                 <span class="keyword">delete</span> l;
00101         }
00102 
00103         <span class="keywordflow">while</span>(!<a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>.empty())
00104         {
00105                 <a class="code" href="classCollection.html">Collection&lt;xy_point&gt;</a> *c;
00106 
00107                 c = <a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>.back();
00108                 <a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>.pop_back();
00109                 <span class="keyword">delete</span> c;
00110         }
00111 
00112         <span class="keywordflow">while</span>(!<a class="code" href="classMultiPan.html#r3">segCollectionsList</a>.empty())
00113         {
00114                 <a class="code" href="classCollection.html">Collection&lt;envelope_segment&gt;</a> *c;
00115 
00116                 c = <a class="code" href="classMultiPan.html#r3">segCollectionsList</a>.back();
00117                 <a class="code" href="classMultiPan.html#r3">segCollectionsList</a>.pop_back();
00118                 <span class="keyword">delete</span> c;
00119         }
00120 }
00121 
<a name="l00127"></a><a class="code" href="classMultiPan.html#a3">00127</a> <a class="code" href="classMultiPan.html">MultiPan</a>* <a class="code" href="classMultiPan.html#a3">MultiPan::clone</a>()
00128 {
00129         <span class="comment">// FIXME: THIS IS BROKEN!!!!!!</span>
00130 
00131         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classMultiPan.html#a0">MultiPan</a>(<a class="code" href="classMultiPan.html#r5">n_channels</a>, <a class="code" href="classMultiPan.html#r1">EnvList</a>);
00132 }
00133    
<a name="l00145"></a><a class="code" href="classMultiPan.html#a4">00145</a> <span class="keywordtype">void</span> <a class="code" href="classMultiPan.html#a4">MultiPan::addEntry</a>(<span class="keywordtype">float</span> t, ...)
00146 {
00147         va_list marker;
00148         <span class="keywordtype">int</span> i;
00149         <span class="keywordtype">float</span> y_i;
00150 
00151         <span class="keywordflow">if</span>(<a class="code" href="classMultiPan.html#r0">useEnvDirectly</a> == <span class="keyword">true</span>)
00152         {
00153                 cout &lt;&lt; <span class="stringliteral">"Warning: called MultiPan::addEntry on a MultiPan object"</span> &lt;&lt; endl;
00154                 cout &lt;&lt; <span class="stringliteral">" that is using ENVs directly"</span> &lt;&lt; endl;
00155         }
00156 
00157         <span class="comment">// now actually set the entries</span>
00158         va_start(marker, t);
00159         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="classMultiPan.html#r5">n_channels</a>;i++)
00160         {
00161                 y_i = va_arg(marker, <span class="keywordtype">double</span>);
00162                 <a class="code" href="classMultiPan.html#d0">addEntryHelperFn</a>(i, t, y_i);
00163         }
00164         va_end(marker);
00165 }
00166    
<a name="l00190"></a><a class="code" href="classMultiPan.html#a5">00190</a> <span class="keywordtype">void</span> <a class="code" href="classMultiPan.html#a5">MultiPan::addEntryLocation</a>(<span class="keywordtype">float</span> t, <span class="keywordtype">float</span> theta, <span class="keywordtype">float</span> radius)
00191 {
00192         <span class="keyword">typedef</span> <span class="keyword">struct</span>
00193 <span class="keyword">        </span>{
00194                 <span class="keywordtype">float</span> x, y, dist;
00195         } Speaker;
00196         Speaker **SpeakerList;
00197         Speaker *curSpeaker;
00198         <span class="keywordtype">float</span> curTheta, curX, curY, total_dist;
00199         <span class="keywordtype">int</span> i;
00200 
00201         <span class="keywordflow">if</span>(<a class="code" href="classMultiPan.html#r0">useEnvDirectly</a> == <span class="keyword">true</span>)
00202         {
00203                 cout &lt;&lt; <span class="stringliteral">"Warning: called MultiPan::addEntry on a MultiPan object"</span> &lt;&lt; endl;
00204                 cout &lt;&lt; <span class="stringliteral">" that is using ENVs directly"</span> &lt;&lt; endl;
00205         }
00206 
00207         <span class="comment">// create an array of speakers</span>
00208         SpeakerList = <span class="keyword">new</span> Speaker *[<a class="code" href="classMultiPan.html#r5">n_channels</a>];
00209         cout &lt;&lt; <span class="stringliteral">"Speaker Locations:"</span> &lt;&lt; endl;;
00210         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="classMultiPan.html#r5">n_channels</a>;i++)
00211         {
00212                 curSpeaker = <span class="keyword">new</span> Speaker();
00213 
00214                 curTheta = 2.0 * M_PI * (<span class="keywordtype">double</span>)i / (<span class="keywordtype">double</span>)n_channels;
00215                 curSpeaker-&gt;x = cos(curTheta);
00216                 curSpeaker-&gt;y = sin(curTheta);
00217                 cout &lt;&lt; <span class="stringliteral">"\tx = "</span> &lt;&lt; curSpeaker-&gt;x;
00218                 cout &lt;&lt; <span class="stringliteral">", y="</span> &lt;&lt; curSpeaker-&gt;y &lt;&lt; endl;
00219 
00220                 SpeakerList[i] = curSpeaker;
00221         }
00222 
00223         <span class="comment">// define a squared function, but just make it a macro, and be</span>
00224         <span class="comment">//  reasonably sure its name doesn't conflict with anything else</span>
00225 <span class="preprocessor">        #define JBL_SQRD(x) ((x)*(x))</span>
00226 <span class="preprocessor"></span>
00227         <span class="comment">// figure out how far all the speakers are from the sound</span>
00228         curX = radius * cos(theta);
00229         curY = radius * sin(theta);
00230         total_dist = 0;
00231         <span class="keywordflow">for</span>(i=0;i&lt;n_channels;i++)
00232         {
00233                 SpeakerList[i]-&gt;dist = 
00234                         1.0 / (
00235                                 1.0 *
00236                                 (
00237                                 JBL_SQRD(curX - SpeakerList[i]-&gt;x) +
00238                                 JBL_SQRD(curY - SpeakerList[i]-&gt;y) 
00239                                 ) + 
00240                                 0.5
00241                         );
00242                 total_dist += SpeakerList[i]-&gt;dist;
00243         }
00244 
00245         <span class="comment">// now set the interpolator entries</span>
00246         cout &lt;&lt; <span class="stringliteral">"Speaker Relative Amplitudes:"</span> &lt;&lt; endl;
00247         <span class="keywordflow">for</span>(i=0;i&lt;n_channels;i++)
00248         {
00249                 <a class="code" href="classMultiPan.html#d0">addEntryHelperFn</a>(i, t, SpeakerList[i]-&gt;dist/total_dist);
00250 
00251                 cout &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; SpeakerList[i]-&gt;dist/total_dist &lt;&lt; endl;
00252         }
00253 
00254         <span class="comment">// kill the speakers</span>
00255         <span class="keywordflow">for</span>(i=0;i&lt;n_channels;i++)
00256                 <span class="keyword">delete</span> SpeakerList[i];
00257         <span class="keyword">delete</span> SpeakerList;
00258 }
00259 
<a name="l00273"></a><a class="code" href="classMultiPan.html#a6">00273</a> <a class="code" href="classMultiTrack.html">MultiTrack</a>* <a class="code" href="classMultiPan.html#a6">MultiPan::spatialize</a>(<a class="code" href="classTrack.html">Track</a>&amp; t, <span class="keywordtype">int</span> numTracks)
00274 {
00275         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> sampleCount = t.<a class="code" href="classTrack.html#a5">getWave</a>().<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00276         <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate = t.<a class="code" href="classTrack.html#a5">getWave</a>().<a class="code" href="classSoundSample.html#a5">getSamplingRate</a>();
00277 
00278         <span class="comment">// create an empty multi track object</span>
00279         <a class="code" href="classMultiTrack.html">MultiTrack</a> *mt = <span class="keyword">new</span> <a class="code" href="classMultiTrack.html">MultiTrack</a>(numTracks, sampleCount, samplingRate);
00280 
00281         <span class="comment">// cycle through interpolators and tell them duration and sampleCount</span>
00282         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classMultiPan.html#r5">n_channels</a>; i++)
00283         {
00284                 (<a class="code" href="classMultiPan.html#r1">EnvList</a>[i])-&gt;setSamplingRate(samplingRate);
00285                 (<a class="code" href="classMultiPan.html#r1">EnvList</a>[i])-&gt;setDuration((<span class="keywordtype">float</span>)sampleCount / 
00286                                           (<span class="keywordtype">float</span>)samplingRate);
00287         }
00288 
00289         <span class="comment">// get references to the input</span>
00290         <a class="code" href="classSoundSample.html">SoundSample</a> &amp;inWave = t.<a class="code" href="classTrack.html#a5">getWave</a>();
00291         <a class="code" href="classSoundSample.html">SoundSample</a> &amp;inAmp  = t.<a class="code" href="classTrack.html#a7">getAmp</a>();
00292 
00293         <span class="comment">// for each channel</span>
00294         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> c=0; c&lt;n_channels; c++)
00295         {
00296                 <span class="comment">// get an iterator for the current interpolator</span>
00297                 <a class="code" href="classIterator.html">Iterator&lt;m_value_type&gt;</a> iter = (<a class="code" href="classMultiPan.html#r1">EnvList</a>[c])-&gt;valueIterator();
00298 
00299                 <span class="comment">// get references for this channel</span>
00300                 <a class="code" href="classSoundSample.html">SoundSample</a> &amp;thisWave = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(c)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>();
00301                 <a class="code" href="classSoundSample.html">SoundSample</a> &amp;thisAmp  = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(c)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00302 
00303                 <span class="comment">// Iterate over each sample</span>
00304                 <a class="code" href="Types_8h.html#a3">m_value_type</a> scale;
00305                 <span class="keywordflow">for</span>(<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> i=0; i&lt;sampleCount; i++)
00306                 {
00307                         <span class="comment">// calculate scaling factor -- FIXME, I don't </span>
00308                         <span class="comment">//  understand what Pan.cpp does here, what is</span>
00309                         <span class="comment">//  'pos' for?</span>
00310                         scale = iter.<a class="code" href="classIterator.html#a5">next</a>();
00311 
00312                         thisWave[i] = scale * inWave[i];
00313                         thisAmp[i]  = scale * inAmp[i];
00314                 }
00315         }
00316 
00317         <span class="comment">// Return the multitrack object</span>
00318         <span class="keywordflow">return</span> mt;
00319 }
00320 
<a name="l00321"></a><a class="code" href="classMultiPan.html#d0">00321</a> <span class="keywordtype">void</span> <a class="code" href="classMultiPan.html#d0">MultiPan::addEntryHelperFn</a>(<span class="keywordtype">int</span> envIdx, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> amp)
00322 {
00323         <a class="code" href="structxy__point.html">xy_point</a> xy;
00324         <a class="code" href="structenvelope__segment.html">envelope_segment</a> seg;
00325 
00326         xy.<a class="code" href="structxy__point.html#o0">x</a> = t;
00327         xy.<a class="code" href="structxy__point.html#o1">y</a> = amp;
00328         (<a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>[envIdx])-&gt;add(xy);
00329 
00330         <span class="keywordflow">if</span>((<a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>[envIdx])-&gt;size() &gt; 1)
00331         {
00332                 seg.<a class="code" href="structenvelope__segment.html#o0">interType</a> = <a class="code" href="Types_8h.html#a13a11">LINEAR</a>;
00333                 seg.<a class="code" href="structenvelope__segment.html#o3">lengthType</a>  = <a class="code" href="Types_8h.html#a12a7">FIXED</a>;
00334                 seg.<a class="code" href="structenvelope__segment.html#o2">timeValue</a> = 1.0;
00335                 (<a class="code" href="classMultiPan.html#r3">segCollectionsList</a>[envIdx])-&gt;add(seg); 
00336         }
00337 
00338         <a class="code" href="classCollection.html">Collection&lt;xy_point&gt;</a> c1 = <a class="code" href="classCollection.html">Collection&lt;xy_point&gt;</a>(*<a class="code" href="classMultiPan.html#r2">xyCollectionsList</a>[envIdx]);
00339         <a class="code" href="classCollection.html">Collection&lt;envelope_segment&gt;</a> c2 = <a class="code" href="classCollection.html">Collection&lt;envelope_segment&gt;</a>(*<a class="code" href="classMultiPan.html#r3">segCollectionsList</a>[envIdx]);
00340         (<a class="code" href="classMultiPan.html#r1">EnvList</a>[envIdx]) = <span class="keyword">new</span> <a class="code" href="classEnvelope.html">Envelope</a>(*xyCollectionsList[envIdx],
00341                                                         *segCollectionsList[envIdx]);
00342 }
00343 
<a name="l00344"></a><a class="code" href="classMultiPan.html#a7">00344</a> <span class="keywordtype">void</span> <a class="code" href="classMultiPan.html#a7">MultiPan::xml_print</a>( ofstream&amp; xmlOutput )
00345 {
00346         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;multipan&gt;"</span> &lt;&lt; endl;
00347         
00348         xmlOutput &lt;&lt; <span class="stringliteral">"\t\t&lt;/multipan&gt;"</span> &lt;&lt; endl;
00349 }
00350 
00351 <span class="preprocessor">#endif //__MULTI_PAN_CPP</span>
00352 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 13:18:12 2005 for LASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
