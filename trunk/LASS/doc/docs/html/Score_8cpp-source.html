<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>LASS: Score.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Score.cpp</h1><a href="Score_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">LASS (additive sound synthesis library)</span>
00003 <span class="comment">Copyright (C) 2005  Sever Tipei (s-tipei@uiuc.edu)</span>
00004 <span class="comment"></span>
00005 <span class="comment">This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">modify it under the terms of the GNU General Public License</span>
00007 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00008 <span class="comment">of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment">GNU General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">along with this program; if not, write to the Free Software</span>
00017 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="comment">//----------------------------------------------------------------------------//</span>
00021 <span class="comment">//</span>
00022 <span class="comment">//      Score.cpp</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//----------------------------------------------------------------------------//</span>
00025 
00026 <span class="preprocessor">#ifndef __SCORE_CPP</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define __SCORE_CPP</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//----------------------------------------------------------------------------//</span>
00030 
00031 <span class="preprocessor">#include "<a class="code" href="Score_8h.html">Score.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="Types_8h.html">Types.h</a>"</span>
00033 <span class="preprocessor">#include &lt;vector&gt;</span>
00034 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00035 
00036 <span class="comment">//----------------------------------------------------------------------------//</span>
00037 
00038 <span class="comment">// This function is the worker function for the rendering threads</span>
<a name="l00039"></a><a class="code" href="Score_8cpp.html#a0">00039</a> <span class="keywordtype">void</span>* <a class="code" href="Score_8cpp.html#a0">multithreaded_render_worker</a>(<span class="keywordtype">void</span> *vtle)
00040 {
00041         <span class="comment">// Cast the argument to correct type</span>
00042         <a class="code" href="structthreadlist__entry.html">threadlist_entry</a> *tle=(<a class="code" href="structthreadlist__entry.html">threadlist_entry</a>*)vtle;
00043 
00044         <span class="comment">// Do the rendering</span>
00045         <a class="code" href="classMultiTrack.html">MultiTrack</a>* renderedSound = tle-&gt;<a class="code" href="structthreadlist__entry.html#o0">snd</a>-&gt;<a class="code" href="classSound.html#a6">render</a>(tle-&gt;<a class="code" href="structthreadlist__entry.html#o6">numChannels</a>, tle-&gt;<a class="code" href="structthreadlist__entry.html#o7">samplingRate</a>);
00046 
00047         <span class="comment">// Obtain the lock so we can modify the list entry</span>
00048         pthread_mutex_lock(tle-&gt;<a class="code" href="structthreadlist__entry.html#o4">listMutex</a>);
00049                 tle-&gt;<a class="code" href="structthreadlist__entry.html#o1">resultTrack</a>=renderedSound;
00050                 tle-&gt;<a class="code" href="structthreadlist__entry.html#o2">done</a>=1;
00051         pthread_mutex_unlock(tle-&gt;<a class="code" href="structthreadlist__entry.html#o4">listMutex</a>);
00052 
00053         <span class="comment">// Signal that we are done</span>
00054         pthread_cond_signal(tle-&gt;<a class="code" href="structthreadlist__entry.html#o5">finishCondition</a>);
00055 
00056         <span class="keywordflow">return</span> NULL;
00057 }
00058 
00059 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00060"></a><a class="code" href="classScore.html#a0">00060</a> <a class="code" href="classScore.html#a0">Score::Score</a>()
00061     : cmm_(NONE)
00062 {
00063     <a class="code" href="classScore.html#r1">reverbObj</a> = NULL;
00064 }
00065 
00066 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00067"></a><a class="code" href="classScore.html#a1">00067</a> <a class="code" href="classMultiTrack.html">MultiTrack</a>* <a class="code" href="classScore.html#a1">Score::render</a>(<span class="keywordtype">int</span> numChannels, <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate)
00068 {
00069 
00070     <span class="comment">// figure out how long the score will run:</span>
00071     <a class="code" href="classIterator.html">Iterator&lt;Sound&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00072     <a class="code" href="Types_8h.html#a2">m_time_type</a> scoreEndTime = 0.0;
00073     <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00074     {
00075         <a class="code" href="classSound.html">Sound</a>&amp; snd = it.<a class="code" href="classIterator.html#a5">next</a>();
00076         <a class="code" href="Types_8h.html#a2">m_time_type</a> soundEndTime = snd.<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>) +
00077                                    snd.<a class="code" href="classSound.html#a11">getTotalDuration</a>();
00078         <span class="keywordflow">if</span> (soundEndTime &gt; scoreEndTime) scoreEndTime = soundEndTime;
00079     }
00080 
00081     <span class="comment">// figure in the reverb die-out period</span>
00082     <span class="keywordflow">if</span>(<a class="code" href="classScore.html#r1">reverbObj</a> != NULL)
00083         scoreEndTime += <a class="code" href="classScore.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a11">getDecay</a>();
00084 
00085     <span class="comment">// how many samples we will need:</span>
00086     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples =
00087         (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a>) (scoreEndTime * float(samplingRate));
00088 
00089     <span class="comment">// now, create an empty multi-track object of the proper length and channels:</span>
00090     <a class="code" href="classMultiTrack.html">MultiTrack</a>* score = <span class="keyword">new</span> <a class="code" href="classMultiTrack.html">MultiTrack</a>(numChannels, numSamples, samplingRate);
00091 
00092     <span class="comment">// for each sound in this score:</span>
00093     <span class="keywordtype">int</span> num=0;
00094     it = <a class="code" href="classCollection.html#a12">iterator</a>();
00095     <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00096     {
00097 
00098         num++;
00099         cout &lt;&lt; <span class="stringliteral">"Sound #"</span> &lt;&lt; num &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; endl;
00100 
00101         <span class="comment">// render the sound:</span>
00102         <a class="code" href="classSound.html">Sound</a>&amp; snd = it.<a class="code" href="classIterator.html#a5">next</a>();
00103         MultiTrack* renderedSound = snd.<a class="code" href="classSound.html#a6">render</a>(numChannels, samplingRate);
00104 
00105         <span class="comment">// composite the rendered sound:</span>
00106         score-&gt;<a class="code" href="classMultiTrack.html#a5">composite</a>(*renderedSound, snd.<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>));
00107         
00108         <span class="comment">// delete the rendered sound:</span>
00109         <span class="keyword">delete</span> renderedSound;
00110     }
00111     
00112     <span class="comment">// do the reverb</span>
00113     <span class="keywordflow">if</span>(<a class="code" href="classScore.html#r1">reverbObj</a> != NULL)
00114     {
00115         cout &lt;&lt; <span class="stringliteral">"Applying reverb to the score..."</span> &lt;&lt; endl;
00116         MultiTrack *tmp = &amp; <a class="code" href="classScore.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a8">do_reverb_MultiTrack</a>(*score);
00117         <span class="keyword">delete</span> score;
00118         score = tmp;
00119     }
00120 
00121     <span class="comment">// perform Clipping management on the composite:</span>
00122     cout &lt;&lt; <span class="stringliteral">"Managing Clipping for the score..."</span> &lt;&lt; endl;
00123     <a class="code" href="classScore.html#e0">manageClipping</a>(score, <a class="code" href="classScore.html#r0">cmm_</a>);
00124     
00125     <span class="comment">// return the composite:</span>
00126     <span class="keywordflow">return</span> score;
00127 }
00128 
00129 <span class="comment">//----------------------------------------------------------------------------//</span>
00130 
00131 <span class="comment">// This is the multithreaded version of render</span>
<a name="l00132"></a><a class="code" href="classScore.html#a2">00132</a> <a class="code" href="classMultiTrack.html">MultiTrack</a>* <a class="code" href="classScore.html#a1">Score::render</a>(<span class="keywordtype">int</span> numChannels, <a class="code" href="Types_8h.html#a4">m_rate_type</a> samplingRate, <span class="keywordtype">int</span> nThreads)
00133 {
00134     <span class="comment">// figure out how long the score will run:</span>
00135     <a class="code" href="classIterator.html">Iterator&lt;Sound&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00136     <a class="code" href="Types_8h.html#a2">m_time_type</a> scoreEndTime = 0.0;
00137     <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00138     {
00139         <a class="code" href="classSound.html">Sound</a>&amp; snd = it.<a class="code" href="classIterator.html#a5">next</a>();
00140         <a class="code" href="Types_8h.html#a2">m_time_type</a> soundEndTime = snd.<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>) +
00141                                    snd.<a class="code" href="classSound.html#a11">getTotalDuration</a>();
00142         <span class="keywordflow">if</span> (soundEndTime &gt; scoreEndTime) scoreEndTime = soundEndTime;
00143     }
00144 
00145     <span class="comment">// figure in the reverb die-out period</span>
00146     <span class="keywordflow">if</span>(<a class="code" href="classScore.html#r1">reverbObj</a> != NULL)
00147         scoreEndTime += <a class="code" href="classScore.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a11">getDecay</a>();
00148 
00149     <span class="comment">// how many samples we will need:</span>
00150     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples =
00151         (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a>) (scoreEndTime * float(samplingRate));
00152 
00153     <span class="comment">// now, create an empty multi-track object of the proper length and channels:</span>
00154     <a class="code" href="classMultiTrack.html">MultiTrack</a>* score = <span class="keyword">new</span> <a class="code" href="classMultiTrack.html">MultiTrack</a>(numChannels, numSamples, samplingRate);
00155 
00156     <span class="comment">// for each sound in this score:</span>
00157     <span class="keywordtype">int</span> num=0;
00158     it = <a class="code" href="classCollection.html#a12">iterator</a>();
00159 
00160     <span class="comment">//Set up for multithreading the rendering</span>
00161     pthread_cond_t finishCondition=PTHREAD_COND_INITIALIZER;
00162     pthread_mutex_t listMutex=PTHREAD_MUTEX_INITIALIZER;
00163 
00164     <span class="comment">//Begin owning the list Mutex</span>
00165     pthread_mutex_lock(&amp;listMutex);
00166 
00167         <span class="comment">// This is a list of the data passed to and from the threads</span>
00168     <a class="code" href="classCollection.html">Collection&lt;threadlist_entry*&gt;</a> threadList;
00169 
00170         <span class="comment">// Populate the list with some initial data</span>
00171     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> th=0;(th&lt;nThreads)&amp;&amp;(it.<a class="code" href="classIterator.html#a4">hasNext</a>());th++)
00172     {
00173            <a class="code" href="structthreadlist__entry.html">threadlist_entry</a> *tle=<span class="keyword">new</span> <a class="code" href="structthreadlist__entry.html">threadlist_entry</a>;
00174            tle-&gt;<a class="code" href="structthreadlist__entry.html#o0">snd</a>=&amp;(it.<a class="code" href="classIterator.html#a5">next</a>());
00175            tle-&gt;<a class="code" href="structthreadlist__entry.html#o2">done</a>=0;
00176            tle-&gt;<a class="code" href="structthreadlist__entry.html#o3">thread</a>=<span class="keyword">new</span> pthread_t;
00177            tle-&gt;<a class="code" href="structthreadlist__entry.html#o4">listMutex</a>=&amp;listMutex;
00178            tle-&gt;<a class="code" href="structthreadlist__entry.html#o5">finishCondition</a>=&amp;finishCondition;
00179            tle-&gt;<a class="code" href="structthreadlist__entry.html#o6">numChannels</a>=numChannels;
00180            tle-&gt;<a class="code" href="structthreadlist__entry.html#o7">samplingRate</a>=samplingRate;
00181 
00182            <span class="comment">// Add to the collection</span>
00183            threadList.<a class="code" href="classCollection.html#a4">add</a>(tle);
00184 
00185            num++;
00186        cout &lt;&lt; <span class="stringliteral">"Sound #"</span> &lt;&lt; num &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; endl;
00187 
00188            <span class="comment">// Begin the thread to render this sound</span>
00189            pthread_create(tle-&gt;<a class="code" href="structthreadlist__entry.html#o3">thread</a>,NULL,<a class="code" href="Score_8cpp.html#a0">multithreaded_render_worker</a>,(<span class="keywordtype">void</span>*)tle);
00190     }
00191 
00192     <span class="comment">//MultiTrack *thisTrack;</span>
00193     <span class="keywordtype">int</span> finishedCount=0;
00194     <span class="keywordflow">while</span> (finishedCount&lt;<a class="code" href="classCollection.html#a10">size</a>())
00195     {
00196                 <span class="comment">// Look thru the list to find done threads</span>
00197             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lm=0;lm&lt;nThreads;lm++)
00198             {
00199                     <a class="code" href="structthreadlist__entry.html">threadlist_entry</a> *tle=threadList.<a class="code" href="classCollection.html#a7">get</a>(lm);
00200                     <span class="keywordflow">if</span>(tle-&gt;<a class="code" href="structthreadlist__entry.html#o2">done</a>)
00201                     {
00202                                 <span class="comment">// Do the composite into the final result</span>
00203                                 score-&gt;<a class="code" href="classMultiTrack.html#a5">composite</a>(*(tle-&gt;<a class="code" href="structthreadlist__entry.html#o1">resultTrack</a>), tle-&gt;<a class="code" href="structthreadlist__entry.html#o0">snd</a>-&gt;<a class="code" href="classParameterLib.html#a6">getParam</a>(<a class="code" href="Sound_8h.html#a8a0">START_TIME</a>));
00204                                 <span class="keyword">delete</span> tle-&gt;<a class="code" href="structthreadlist__entry.html#o1">resultTrack</a>;
00205 
00206                                 <span class="comment">// Reset values in the thread list</span>
00207                                 tle-&gt;<a class="code" href="structthreadlist__entry.html#o1">resultTrack</a>=NULL;
00208                                 tle-&gt;<a class="code" href="structthreadlist__entry.html#o2">done</a>=0;
00209                                 finishedCount++;
00210                         
00211                                 <span class="comment">// If there is another sound still to render, lets do it</span>
00212                                 <span class="keywordflow">if</span>(it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00213                                 {
00214                                         num++;
00215                                 cout &lt;&lt; <span class="stringliteral">"Sound #"</span> &lt;&lt; num &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; endl;
00216                                         tle-&gt;<a class="code" href="structthreadlist__entry.html#o0">snd</a>=&amp;(it.<a class="code" href="classIterator.html#a5">next</a>());
00217                                         pthread_create(tle-&gt;<a class="code" href="structthreadlist__entry.html#o3">thread</a>,NULL,<a class="code" href="Score_8cpp.html#a0">multithreaded_render_worker</a>,(<span class="keywordtype">void</span>*)tle);
00218                                 }
00219                     }
00220             }
00221 
00222                 <span class="comment">// If we haven't rendered everything yet, lets wait for a thread to signal us.</span>
00223             <span class="keywordflow">if</span>(finishedCount!=<a class="code" href="classCollection.html#a10">size</a>())
00224                 pthread_cond_wait(&amp;finishCondition,&amp;listMutex);
00225     }
00226     
00227     <span class="comment">// do the reverb</span>
00228     <span class="keywordflow">if</span>(<a class="code" href="classScore.html#r1">reverbObj</a> != NULL)
00229     {
00230         cout &lt;&lt; <span class="stringliteral">"Applying reverb to the score..."</span> &lt;&lt; endl;
00231         MultiTrack *tmp = &amp; <a class="code" href="classScore.html#r1">reverbObj</a>-&gt;<a class="code" href="classReverb.html#a8">do_reverb_MultiTrack</a>(*score);
00232         <span class="keyword">delete</span> score;
00233         score = tmp;
00234     }
00235 
00236     <span class="comment">// perform Clipping management on the composite:</span>
00237     cout &lt;&lt; <span class="stringliteral">"Managing Clipping for the score..."</span> &lt;&lt; endl;
00238     <a class="code" href="classScore.html#e0">manageClipping</a>(score, <a class="code" href="classScore.html#r0">cmm_</a>);
00239     
00240     <span class="comment">// return the composite:</span>
00241     <span class="keywordflow">return</span> score;
00242 }
00243 
00244 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00245"></a><a class="code" href="classScore.html#a3">00245</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a3">Score::setClippingManagementMode</a>(ClippingManagementMode mode)
00246 {
00247     <a class="code" href="classScore.html#r0">cmm_</a> = mode;
00248 }
00249 
00250 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00251"></a><a class="code" href="classScore.html#a4">00251</a> <a class="code" href="classScore.html#w6">Score::ClippingManagementMode</a> <a class="code" href="classScore.html#a4">Score::getClippingManagementMode</a>()
00252 {
00253     <span class="keywordflow">return</span> <a class="code" href="classScore.html#r0">cmm_</a>;
00254 }
00255 
00256 
00257 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00258"></a><a class="code" href="classScore.html#e0">00258</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#e0">Score::manageClipping</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt, ClippingManagementMode mode)
00259 {
00260     <span class="keywordflow">switch</span> (mode)
00261     {
00262         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w0">NONE</a>:              <span class="keywordflow">break</span>;
00263         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w1">CLIP</a>:              <a class="code" href="classScore.html#h0">clip</a>(mt); <span class="keywordflow">break</span>;
00264         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w2">SCALE</a> :            <a class="code" href="classScore.html#h1">scale</a>(mt); <span class="keywordflow">break</span>;
00265         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w3">CHANNEL_SCALE</a> :    <a class="code" href="classScore.html#h2">channelScale</a>(mt); <span class="keywordflow">break</span>;
00266         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w4">ANTICLIP</a> :         <a class="code" href="classScore.html#h3">anticlip</a>(mt); <span class="keywordflow">break</span>;
00267         <span class="keywordflow">case</span> <a class="code" href="classScore.html#w6w5">CHANNEL_ANTICLIP</a> : <a class="code" href="classScore.html#h4">channelAnticlip</a>(mt); <span class="keywordflow">break</span>;
00268         <span class="keywordflow">default</span> :               <span class="keywordflow">break</span>;
00269     }
00270 }
00271 
00272 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00273"></a><a class="code" href="classScore.html#a5">00273</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a5">Score::use_reverb</a>(<a class="code" href="classReverb.html">Reverb</a> *newReverbObj)
00274 {
00275         <a class="code" href="classScore.html#r1">reverbObj</a> = newReverbObj;
00276 }
00277 
00278 <span class="comment">//----------------------------------------------------------------------------//</span>
00279 <span class="comment">//      PRIVATE FUNCTIONS:</span>
00280 <span class="comment">//----------------------------------------------------------------------------//</span>
00281 
00282 
00283 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00284"></a><a class="code" href="classScore.html#h0">00284</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#h0">Score::clip</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt)
00285 {
00286     cout &lt;&lt; <span class="stringliteral">"Performing CLIP"</span> &lt;&lt; endl;
00287 
00288     <span class="comment">// for each track</span>
00289     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;mt-&gt;<a class="code" href="classCollection.html#a10">size</a>(); t++)
00290     {
00291         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; wave = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>();
00292         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; amp = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00293 
00294         <span class="comment">// for each sample</span>
00295         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = wave.<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00296         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00297         {
00298             <span class="keywordflow">if</span> (wave[s] &gt;  1.0) wave[s] =  1.0;
00299             <span class="keywordflow">if</span> (wave[s] &lt; -1.0) wave[s] = -1.0;
00300             <span class="keywordflow">if</span> (amp[s] &gt;  1.0) amp[s] =  1.0;
00301             <span class="keywordflow">if</span> (amp[s] &lt; -1.0) amp[s] = -1.0;
00302         }
00303         
00304     }
00305 }
00306 
00307 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00308"></a><a class="code" href="classScore.html#h1">00308</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#h1">Score::scale</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt)
00309 {
00310     cout &lt;&lt; <span class="stringliteral">"Performing SCALE"</span> &lt;&lt; endl;
00311 
00312     <span class="comment">// -----</span>
00313     <span class="comment">// first, find the maximum amplitude:</span>
00314 
00315     <a class="code" href="Types_8h.html#a0">m_sample_type</a> maxAmp = 0;
00316     <span class="comment">// for each track</span>
00317     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;mt-&gt;<a class="code" href="classCollection.html#a10">size</a>(); t++)
00318     {
00319         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; amp = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00320         <span class="comment">// for each sample</span>
00321         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = amp.<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00322         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00323         {
00324             <span class="keywordflow">if</span> (amp[s] &gt; maxAmp) maxAmp = amp[s];
00325         }
00326     }
00327     
00328     <span class="comment">// -----</span>
00329     <span class="comment">// create a scaling factor:</span>
00330     <a class="code" href="Types_8h.html#a0">m_sample_type</a> scalingFactor = 1.0 / maxAmp;
00331     
00332     <span class="comment">// -----</span>
00333     <span class="comment">// scale every value by this factor</span>
00334     
00335     <span class="comment">// for each track</span>
00336     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;mt-&gt;<a class="code" href="classCollection.html#a10">size</a>(); t++)
00337     {
00338         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; wave = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>();
00339         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; amp = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00340 
00341         <span class="comment">// for each sample</span>
00342         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = wave.<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00343         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00344         {
00345             wave[s] *= scalingFactor;
00346             amp[s] *= scalingFactor;
00347         }
00348     }
00349 }
00350 
00351 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00352"></a><a class="code" href="classScore.html#h2">00352</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#h2">Score::channelScale</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt)
00353 {
00354     cout &lt;&lt; <span class="stringliteral">"Performing CHANNEL_SCALE"</span> &lt;&lt; endl;
00355 
00356     <span class="comment">// -----</span>
00357     <span class="comment">// for each track</span>
00358     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;mt-&gt;<a class="code" href="classCollection.html#a10">size</a>(); t++)
00359     {
00360         <span class="comment">// -----</span>
00361         <span class="comment">// find the maximum amplitude:</span>
00362         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; wave = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>();
00363         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; amp = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00364         
00365         <a class="code" href="Types_8h.html#a0">m_sample_type</a> maxAmp = 0;
00366 
00367         <span class="comment">// for each sample</span>
00368         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = wave.<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00369         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00370         {
00371             <span class="keywordflow">if</span> (amp[s] &gt; maxAmp) maxAmp = amp[s];
00372         }
00373 
00374         <span class="comment">// -----</span>
00375         <span class="comment">// create a scaling factor:</span>
00376         <a class="code" href="Types_8h.html#a0">m_sample_type</a> scalingFactor = 1.0 / maxAmp;
00377     
00378         <span class="comment">// -----</span>
00379         <span class="comment">// scale every value by this factor</span>
00380         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00381         {
00382             wave[s] *= scalingFactor;
00383             amp[s] *= scalingFactor;
00384         }
00385     
00386     }
00387 }
00388 
00389 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00390"></a><a class="code" href="classScore.html#h3">00390</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#h3">Score::anticlip</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt)
00391 { 
00392     cout &lt;&lt; <span class="stringliteral">"Performing ANTICLIP"</span> &lt;&lt; endl;
00393 
00394     <span class="comment">// this is a dificult one, because we need fast cros-track access.</span>
00395     <span class="comment">// make our own data-structure for this one.</span>
00396     vector&lt;SoundSample*&gt; wave;
00397     vector&lt;SoundSample*&gt; amp;
00398     <span class="keywordtype">int</span> numTracks = mt-&gt;<a class="code" href="classCollection.html#a10">size</a>();
00399     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numTracks; i++)
00400     {
00401         wave.push_back(&amp; mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(i)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>());
00402         amp.push_back(&amp; mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(i)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>());
00403     }
00404 
00405     <span class="comment">// now, for each sample:</span>
00406     <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = wave[0]-&gt;getSampleCount();
00407     <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00408     {
00409         <span class="comment">// find the total amplitude across all tracks.</span>
00410         <a class="code" href="Types_8h.html#a0">m_sample_type</a> totalAmp = 0.0;
00411         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;numTracks; t++)
00412         {
00413             totalAmp += (*amp[t])[s];
00414         }
00415         
00416         <span class="comment">// scale if necessary</span>
00417         <span class="keywordflow">if</span> (totalAmp &gt; 1.0)
00418         {
00419             <a class="code" href="Types_8h.html#a0">m_sample_type</a> scalingFactor = 1.0 / totalAmp;
00420             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;numTracks; t++)
00421             {
00422                 (*amp[t] )[s] *= scalingFactor;
00423                 (*wave[t])[s] *= scalingFactor;
00424             }
00425         }
00426     }
00427 }
00428 
00429 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00430"></a><a class="code" href="classScore.html#h4">00430</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#h4">Score::channelAnticlip</a>(<a class="code" href="classMultiTrack.html">MultiTrack</a>* mt)
00431 {
00432     cout &lt;&lt; <span class="stringliteral">"Performing CHANNEL_ANTICLIP"</span> &lt;&lt; endl;
00433 
00434     <span class="comment">// for each track</span>
00435     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t=0; t&lt;mt-&gt;<a class="code" href="classCollection.html#a10">size</a>(); t++)
00436     {
00437         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; wave = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a5">getWave</a>();
00438         <a class="code" href="classSoundSample.html">SoundSample</a>&amp; amp = mt-&gt;<a class="code" href="classCollection.html#a7">get</a>(t)-&gt;<a class="code" href="classTrack.html#a7">getAmp</a>();
00439         
00440         <span class="comment">// for each sample</span>
00441         <a class="code" href="Types_8h.html#a1">m_sample_count_type</a> numSamples = wave.<a class="code" href="classSoundSample.html#a6">getSampleCount</a>();
00442         <span class="keywordflow">for</span> (<a class="code" href="Types_8h.html#a1">m_sample_count_type</a> s=0; s&lt;numSamples; s++)
00443         {
00444             <span class="keywordflow">if</span> (amp[s] &gt; 1.0)
00445             {
00446                 <span class="comment">// scale this sample:</span>
00447                 wave[s] *= 1.0 / amp[s];
00448                 amp[s] = 1.0;
00449             }
00450         }
00451     }
00452 }
00453 
00454 <span class="comment">//XML FUNCTIONS---------------------------------------------------------------//</span>
00455 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00456"></a><a class="code" href="classScore.html#a9">00456</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a9">Score::xml_read</a>(<a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a> *scoretag)
00457 {
00458         
00459         <span class="comment">// Sanity Check</span>
00460         <span class="keywordflow">if</span>(strcmp(<span class="stringliteral">"score"</span>,scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>))
00461         {
00462                 printf(<span class="stringliteral">"Not a score tag!  This is a %s tag!\n"</span>,scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o0">name</a>);
00463                 <span class="keywordflow">return</span>;
00464         }
00465         
00466         
00467         
00468 
00469         <span class="comment">// Perhaps that an error should be thrown if the following  are *not*</span>
00470         <span class="comment">// found...  But i'm just coding now for sake of demonstration.</span>
00471         <a class="code" href="classXmlReader_1_1xmltag.html">XmlReader::xmltag</a> *childtag;
00472         <span class="keywordtype">char</span> *value;
00473         <a class="code" href="classScore.html#o0">reverbHash</a> = <span class="keyword">new</span> hash_map&lt;long, Reverb *&gt;;
00474         <a class="code" href="classScore.html#o1">dvHash</a> = <span class="keyword">new</span> hash_map&lt;long, DynamicVariable *&gt;;
00475         
00476         <span class="keywordflow">while</span>(childtag=scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"reverb"</span>))
00477         {
00478                 <span class="keywordflow">if</span>(value=childtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a3">getParamValue</a>(<span class="stringliteral">"id"</span>))
00479                 {
00480                         <span class="keywordtype">int</span> id = atoi(value);
00481                         <a class="code" href="classReverb.html">Reverb</a>* tempRev = <span class="keyword">new</span> <a class="code" href="classReverb.html">Reverb</a>(0);
00482                         tempRev-&gt;<a class="code" href="classReverb.html#a19">xml_read</a>(childtag);
00483                         (*reverbHash)[id] = tempRev;
00484                 }
00485         }
00486         
00487         <span class="keywordflow">while</span>(childtag=scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"dv"</span>))
00488         {
00489                 <span class="keywordflow">if</span>(value=childtag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a3">getParamValue</a>(<span class="stringliteral">"id"</span>))
00490                 {
00491                         <span class="keywordtype">int</span> id = atoi(value);
00492                         <a class="code" href="classDynamicVariable.html">DynamicVariable</a>* tempDV = <a class="code" href="classDynamicVariable.html#e0">DynamicVariable::create_dv_from_xml</a>(childtag);
00493                         (*dvHash)[id] = tempDV;
00494                 }
00495         }
00496         
00497         <span class="keywordflow">if</span>(value=scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"reverb_ptr"</span>,<span class="stringliteral">"id"</span>))
00498         {
00499                 <span class="keywordtype">long</span> id=atoi(value);
00500                 <a class="code" href="classReverb.html">Reverb</a> * temp;
00501                 temp = (*reverbHash)[id];
00502                 
00503                 <span class="keywordflow">if</span>(temp != NULL)
00504                 {
00505                         <a class="code" href="classScore.html#a5">use_reverb</a>(temp);
00506                 }
00507         }
00508 
00509         <span class="keywordflow">if</span>(value=scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#a5">findChildParamValue</a>(<span class="stringliteral">"cmm_"</span>,<span class="stringliteral">"value"</span>))
00510         {
00511                 <a class="code" href="classScore.html#a3">setClippingManagementMode</a>((<a class="code" href="classScore.html#w6">Score::ClippingManagementMode</a>)atoi(value));
00512         }
00513         
00514         <span class="keywordflow">while</span>(childtag=scoretag-&gt;<a class="code" href="classXmlReader_1_1xmltag.html#o3">children</a>-&gt;find(<span class="stringliteral">"sound"</span>))
00515         {
00516                 <a class="code" href="classSound.html">Sound</a> s;
00517                 s.<a class="code" href="classSound.html#a10">xml_read</a>(childtag, <a class="code" href="classScore.html#o0">reverbHash</a>, <a class="code" href="classScore.html#o1">dvHash</a>);
00518                 <a class="code" href="classCollection.html#a4">add</a>(s); 
00519         }
00520 }
00521 
00522 
00523 <span class="comment">//----------------------------------------------------------------------------//</span>
<a name="l00524"></a><a class="code" href="classScore.html#a7">00524</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a6">Score::xml_print</a>( ofstream&amp; xmlOutput )
00525 {
00526         <span class="comment">// revObjs is a list of the distinct reverb objects in this</span>
00527         <span class="comment">// score and its associated sounds, partials, etc.</span>
00528         <span class="comment">//  Inline in the score's xml, reverb objects are denoted by unique</span>
00529         <span class="comment">//  id's (their pointers), then these objects are displayed fully at</span>
00530         <span class="comment">//  the end of the file</span>
00531         list&lt;Reverb*&gt; revObjs;
00532         revObjs.push_back( <a class="code" href="classScore.html#r1">reverbObj</a> );
00533         
00534         <span class="comment">// dynObjs is a list of Dynamic Variables, used for the same kind of</span>
00535         <span class="comment">//  thing as reverb</span>
00536         list&lt;DynamicVariable*&gt; dynObjs;
00537         xmlOutput &lt;&lt; <span class="stringliteral">"&lt;score&gt;"</span> &lt;&lt; endl;
00538         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;cmm_ value=\""</span> &lt;&lt; <a class="code" href="classScore.html#a4">getClippingManagementMode</a>() &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00539         xmlOutput &lt;&lt; <span class="stringliteral">"\t&lt;reverb_ptr id=\""</span> &lt;&lt; (<span class="keywordtype">long</span>)<a class="code" href="classScore.html#r1">reverbObj</a> &lt;&lt; <span class="stringliteral">"\" /&gt;"</span> &lt;&lt; endl;
00540                 <span class="comment">// XML for this score's sounds</span>
00541         <a class="code" href="classIterator.html">Iterator&lt;Sound&gt;</a> it = <a class="code" href="classCollection.html#a12">iterator</a>();
00542         <span class="keywordflow">while</span> (it.<a class="code" href="classIterator.html#a4">hasNext</a>())
00543         {
00544                 <a class="code" href="classSound.html">Sound</a>&amp; snd = it.<a class="code" href="classIterator.html#a5">next</a>();
00545                 snd.<a class="code" href="classSound.html#a9">xml_print</a>( xmlOutput, revObjs, dynObjs );
00546         }
00547         
00548         <span class="comment">// XML for this score's reverb objects</span>
00549         list&lt;Reverb*&gt;::const_iterator revit;
00550         <span class="keywordflow">for</span>( revit=revObjs.begin(); revit != revObjs.end(); revit++ )
00551         {
00552             <span class="keywordflow">if</span>( (*revit) != NULL )
00553                 (*revit)-&gt;xml_print( xmlOutput );
00554         }
00555                 <span class="comment">// XML for this score's dynamic variables</span>
00556         list&lt;DynamicVariable*&gt;::const_iterator dynit;
00557         <span class="keywordflow">for</span>( dynit=dynObjs.begin(); dynit != dynObjs.end(); dynit++ )
00558         {
00559             <span class="keywordflow">if</span>( (*dynit) != NULL )
00560                 (*dynit)-&gt;xml_print( xmlOutput );
00561         }
00562 
00563         xmlOutput &lt;&lt; <span class="stringliteral">"&lt;/score&gt;"</span> &lt;&lt; endl;
00564         xmlOutput.close();
00565 }
00566 
<a name="l00567"></a><a class="code" href="classScore.html#a8">00567</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a6">Score::xml_print</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * xmlOutputPath)
00568 {
00569         ofstream xmlOutput(xmlOutputPath);
00570         <span class="keywordflow">if</span>(!xmlOutput)
00571         {
00572                 cout &lt;&lt; <span class="stringliteral">"Error Opening file for XML output!"</span> &lt;&lt; endl;
00573         }
00574         <span class="keywordflow">else</span>
00575         {
00576                 <a class="code" href="classScore.html#a6">xml_print</a>(xmlOutput);
00577         }
00578 }
00579 
<a name="l00580"></a><a class="code" href="classScore.html#a6">00580</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a6">Score::xml_print</a>()
00581 {
00582         ofstream xmlOutput(<span class="stringliteral">"xmloutput.xml"</span>);
00583         <span class="keywordflow">if</span>(!xmlOutput)
00584         {
00585                 cout &lt;&lt; <span class="stringliteral">"Error Opening file for XML output!"</span> &lt;&lt; endl;
00586         }
00587         <span class="keywordflow">else</span>
00588         {
00589                 <a class="code" href="classScore.html#a6">xml_print</a>(xmlOutput);
00590         }
00591 }
00592 
00593 
00594 
00595 <span class="comment">//----------------------------------------------------------------------------//</span>
00596 <span class="preprocessor">#endif //__SCORE_CPP</span>
00597 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 13:18:12 2005 for LASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
